// src/App.js
import React, { useEffect } from 'react';
import { LogBox, Platform, ErrorUtils } from 'react-native'; // Added ErrorUtils import
import { NavigationContainer } from '@react-navigation/native';
import { AuthProvider } from './hooks/useAuth';
import { SearchProvider } from './providers/SearchProvider';
import AppNavigator from './navigation/AppNavigator';
import ErrorBoundary from './components/ErrorBoundary';

// Set up global error handler at the VERY TOP of the module
const originalErrorHandler = ErrorUtils.getGlobalHandler();

ErrorUtils.setGlobalHandler((error, isFatal) => {
  console.error('!!! GLOBAL ERROR HANDLER CAUGHT !!!');
  console.error('Error Message:', error.message);
  console.error('Is Fatal:', isFatal);
  console.error('Full Stack Trace:', error.stack);
  
  // Additional debugging for 'src' errors
  if (error.message && error.message.includes("Property 'src' doesn't exist")) {
    console.error('ðŸ” Detected src property error!');
    console.error('Error occurred in:', error.stack.split('\n')[1]); // Get the first relevant line of stack
  }
  
  // Still call the original handler to show the red screen
  originalErrorHandler(error, isFatal);
});

// IGNORE WARNINGS
LogBox.ignoreLogs([
  'Non-serializable values were found in the navigation state',
  'Require cycles are allowed',
  'Remote debugger',
  'Cannot update a component',
  '[runtime not ready]',
  'Expo Go app detected',
  'Using RevenueCat in Browser Mode',
  'Property \'src\' doesn\'t exist',
  'Native Firebase Analytics not available',
]);

function App() {
  useEffect(() => {
    console.log('ðŸš€ App mounted - Platform:', Platform.OS);
    
    // Add slight delay to ensure all modules are loaded
    const timer = setTimeout(() => {
      console.log('âœ… App initialization complete');
    }, 1000);
    
    return () => clearTimeout(timer);
  }, []);

  return (
    <ErrorBoundary>
      <AuthProvider>
        <SearchProvider>
          <NavigationContainer>
            <AppNavigator />
          </NavigationContainer>
        </SearchProvider>
      </AuthProvider>
    </ErrorBoundary>
  );
}

export default App;
