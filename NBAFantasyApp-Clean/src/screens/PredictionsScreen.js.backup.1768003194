import React, { useState, useEffect, useCallback } from 'react';
import { useAnalytics } from '../hooks/useAnalytics';
import {
  View,
  Text,
  ScrollView,
  StyleSheet,
  TouchableOpacity,
  FlatList,
  Alert,
  Modal,
  ActivityIndicator,
  Dimensions,
  RefreshControl,
  Platform,
  TextInput,
  Switch,
  SafeAreaView,
} from 'react-native';
import { LinearGradient } from 'expo-linear-gradient';
import { Ionicons } from '@expo/vector-icons';
import AsyncStorage from '@react-native-async-storage/async-storage';

// Import navigation helper - FIXED: Use the helper functions, not navigate directly
import { useAppNavigation } from '../navigation/NavigationHelper';

// Import search components
import { useSearch } from '../providers/SearchProvider';  
import SearchBar from '../components/SearchBar';

// Import RevenueCat hooks
import revenueCatService from '../services/revenuecat-service';
import useDailyLocks from '../hooks/useDailyLocks';
import Purchases from 'react-native-purchases';

const { width } = Dimensions.get('window');

// Simple analytics function
`, eventParams);
    }
    
    try {
      const existingEvents = JSON.parse(await AsyncStorage.getItem('analytics_events') || '[]');
      existingEvents.push({
        event: eventName,
        params: eventParams,
        timestamp: new Date().toISOString(),
        platform: Platform.OS,
      });
      if (existingEvents.length > 100) {
        existingEvents.splice(0, existingEvents.length - 100);
      }
      await AsyncStorage.setItem('analytics_events', JSON.stringify(existingEvents));
    } catch (storageError) {
      console.warn('Could not save analytics event locally:', storageError.message);
    }
  } catch (error) {
    console.warn('Analytics event failed:', error.message);
  }
};

// Enhanced 2 Free Predictions System
const usePredictionCounter = () => {
  const [remainingPredictions, setRemainingPredictions] = useState(2);
  const [isLoading, setIsLoading] = useState(true);
  
  useEffect(() => {
    loadPredictionCounter();
  }, []);
  
  const loadPredictionCounter = async () => {
    try {
      setIsLoading(true);
      const today = new Date().toDateString();
      const lastDate = await AsyncStorage.getItem('@prediction_last_date');
      let remaining = 2; // Start with 2 free predictions
      
      // Only use stored count if it's the same day
      if (lastDate === today) {
        const storedCount = await AsyncStorage.getItem('@prediction_remaining');
        remaining = parseInt(storedCount) || 2;
      } else {
        // New day - reset counter
        await AsyncStorage.setItem('@prediction_last_date', today);
        await AsyncStorage.setItem('@prediction_remaining', '2');
      }
      
      setRemainingPredictions(remaining);
    } catch (error) {
      console.error('Error loading prediction counter:', error);
    } finally {
      setIsLoading(false);
    }
  };
  
  const usePrediction = async () => {
    try {
      // First, verify user has Success Metrics access
      const customerInfo = await Purchases.getCustomerInfo();
      if (!customerInfo.entitlements.active?.success_metrics_access) {
        return { 
          allowed: false, 
          reason: 'no_access',
          message: 'This feature requires Success Metrics subscription.'
        };
      }
      
      const today = new Date().toDateString();
      const lastDate = await AsyncStorage.getItem('@prediction_last_date');
      let remaining = 2;
      
      // Reset if new day
      if (lastDate !== today) {
        await AsyncStorage.setItem('@prediction_last_date', today);
        await AsyncStorage.setItem('@prediction_remaining', '2');
        remaining = 2;
      } else {
        const storedCount = await AsyncStorage.getItem('@prediction_remaining');
        remaining = parseInt(storedCount) || 2;
      }
      
      // Check if any free predictions left
      if (remaining > 0) {
        // Use one prediction
        remaining--;
        await AsyncStorage.setItem('@prediction_remaining', remaining.toString());
        setRemainingPredictions(remaining);
        
        return { 
          allowed: true, 
          remaining,
          reason: 'free',
          message: `Prediction generated! ${remaining} free predictions left today.`
        };
      } else {
        // No free predictions left
        return { 
          allowed: false, 
          remaining: 0,
          reason: 'limit_reached',
          message: 'You\'ve used all 2 free predictions today.'
        };
      }
    } catch (error) {
      console.error('Error checking prediction counter:', error);
      return { 
        allowed: false, 
        reason: 'error',
        message: 'Error checking prediction availability.'
      };
    }
  };
  
  const purchasePredictionPack = async () => {
    try {
      const { customerInfo } = await Purchases.purchaseProduct('prediction_pack');
      // Check if purchase was successful
      if (customerInfo.entitlements.active?.unlimited_predictions) {
        // Add 5 more predictions
        const current = await AsyncStorage.getItem('@prediction_remaining');
        const newCount = parseInt(current || '0') + 5;
        await AsyncStorage.setItem('@prediction_remaining', newCount.toString());
        setRemainingPredictions(newCount);
        return { success: true, message: 'Purchased 5 additional predictions!' };
      }
      return { success: false, message: 'Purchase verification failed.' };
    } catch (error) {
      if (!error.userCancelled) {
        return { success: false, message: 'Purchase failed. Please try again.' };
      }
      return { success: false, message: 'Purchase cancelled.' };
    }
  };
  
  return { remainingPredictions, isLoading, usePrediction, purchasePredictionPack, loadPredictionCounter };
};

// Helper functions for dynamic styling (MOVED OUTSIDE COMPONENT)
const getSportBadgeStyle = (sport) => {
  switch (sport) {
    case 'NBA': return { backgroundColor: '#ef444420', borderWidth: 1, borderColor: '#ef444430' };
    case 'NFL': return { backgroundColor: '#3b82f620', borderWidth: 1, borderColor: '#3b82f630' };
    case 'NHL': return { backgroundColor: '#1e40af20', borderWidth: 1, borderColor: '#1e40af30' };
    case 'MLB': return { backgroundColor: '#f59e0b20', borderWidth: 1, borderColor: '#f59e0b30' };
    default: return { backgroundColor: '#6b728020', borderWidth: 1, borderColor: '#6b728030' };
  }
};

const getSportTextStyle = (sport) => {
  switch (sport) {
    case 'NBA': return { color: '#ef4444' };
    case 'NFL': return { color: '#3b82f6' };
    case 'NHL': return { color: '#1e40af' };
    case 'MLB': return { color: '#f59e0b' };
    default: return { color: '#6b7280' };
  }
};

const getCategoryStyle = (category) => {
  switch (category) {
    case 'High Probability': return { backgroundColor: '#10b98120', borderWidth: 1, borderColor: '#10b98130' };
    case 'AI Generated': return { backgroundColor: '#8b5cf620', borderWidth: 1, borderColor: '#8b5cf630' };
    case 'Value Bet': return { backgroundColor: '#f59e0b20', borderWidth: 1, borderColor: '#f59e0b30' };
    default: return { backgroundColor: '#6b728020', borderWidth: 1, borderColor: '#6b728030' };
  }
};

const getCategoryTextStyle = (category) => {
  switch (category) {
    case 'High Probability': return { color: '#10b981' };
    case 'AI Generated': return { color: '#8b5cf6' };
    case 'Value Bet': return { color: '#f59e0b' };
    default: return { color: '#6b7280' };
  }
};

const getConfidenceStyle = (confidence) => {
  if (confidence >= 90) return { backgroundColor: '#10b981', borderWidth: 1, borderColor: '#10b98140' };
  if (confidence >= 80) return { backgroundColor: '#3b82f6', borderWidth: 1, borderColor: '#3b82f640' };
  if (confidence >= 70) return { backgroundColor: '#f59e0b', borderWidth: 1, borderColor: '#f59e0b40' };
  return { backgroundColor: '#ef4444', borderWidth: 1, borderColor: '#ef444440' };
};

export default function PredictionsScreen() {
  const { logEvent, logNavigation, logSecretPhrase } = useAnalytics();

  // FIXED: Use the app navigation helper
  const navigation = useAppNavigation();
  const { searchHistory, addToSearchHistory } = useSearch();
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [picks, setPicks] = useState([]);
  const [filteredPicks, setFilteredPicks] = useState([]);
  const [selectedSport, setSelectedSport] = useState('All');
  const [searchQuery, setSearchQuery] = useState('');
  const [showSearch, setShowSearch] = useState(false);
  const [customPrompt, setCustomPrompt] = useState('');
  const [generating, setGenerating] = useState(false);
  const [showGeneratingModal, setShowGeneratingModal] = useState(false);
  const [selectedPrompt, setSelectedPrompt] = useState('');
  
  // Enhanced UI state
  const [showSimpleAnalysis, setShowSimpleAnalysis] = useState(false);
  const [advancedAnalytics, setAdvancedAnalytics] = useState([
    "üìä Use 'trending' in prompts for picks with upward momentum",
    "üí∞ Combine multiple sports for diversified parlays",
    "üéØ Target player props with >85% historical hit rate",
    "üìà Look for line movements of 2+ points for value",
    "üîç Search specific players facing weak defenses",
    "‚ö° Use 'hot streak' in prompts for in-form players",
    "üé≤ Include 'value bet' for underrated opportunities",
    "üèÜ Focus on primetime games for higher volume data"
  ]);
  
  // Daily Locks Hook
  const daily = useDailyLocks();
  
  // Enhanced 2-Free Predictions Hook
  const predictionCounter = usePredictionCounter();
  
  // FIXED: Updated navigation functions to use the navigation helper methods
  // Based on the logs, ExpertSelections and PlayerMetrics are likely screens within SuccessMetrics
  // Let's use goToSuccessMetrics for all SuccessMetrics-related navigation
  const handleNavigateToExpertSelections = () => {
    // FIXED: Use navigation helper method for Success Metrics
    navigation.goToSuccessMetrics();
    logEvent('predictions_navigate_expert_selections', {
      screen_name: 'Predictions Screen'
    });
  };

  const handleNavigateToPlayerMetrics = () => {
    // FIXED: Use navigation helper method for Success Metrics
    navigation.goToSuccessMetrics();
    logEvent('predictions_navigate_player_metrics', {
      screen_name: 'Predictions Screen'
    });
  };

  const handleNavigateToAnalytics = () => {
    // FIXED: Use navigation helper method instead of navigate directly
    navigation.goToAnalytics();
    logEvent('predictions_navigate_analytics', {
      screen_name: 'Predictions Screen'
    });
  };

  const handleNavigateToParlayBuilder = () => {
    // FIXED: Use navigation helper method instead of navigate directly
    navigation.goToParlayBuilder();
    logEvent('predictions_navigate_parlay', {
      screen_name: 'Predictions Screen'
    });
  };

  // FIXED: Add method to navigate to premium (Success Metrics)
  const handleNavigateToPremium = () => {
    // FIXED: Use navigation helper method for Success Metrics
    navigation.goToSuccessMetrics();
    logEvent('predictions_navigate_premium', {
      screen_name: 'Predictions Screen'
    });
  };

  // Enhanced Random Prompts System
  const getRandomPrompts = () => {
    const allPrompts = [
      // High Probability Picks
      "Generate top 3 high probability NBA player props for tonight",
      "Show me NFL picks with over 85% confidence",
      "Best MLB value bets with positive expected value",
      
      // Sport Specific
      "NBA player props trending above market expectations",
      "NFL over/under picks based on weather conditions",
      "MLB strikeout props with high strikeout pitchers",
      "NHL goal scorer props on power play units",
      
      // Parlay Focused
      "Create a 3-leg parlay with highest probability",
      "Best 2-team parlay for tonight's games",
      "Safe parlay suggestions with +200 odds",
      
      // Advanced Analytics
      "Picks based on machine learning trend analysis",
      "Player props with significant market mispricing",
      "Generate picks using advanced matchup metrics",
      "High probability picks with low variance",
      
      // User Friendly
      "Easy wins for tonight's basketball games",
      "Safe bets with high chance of winning",
      "Best picks for beginners this weekend",
      "Low risk predictions with good returns",
      
      // Customizable
      "Show me {sport} picks with {condition}",
      "Generate {number}-leg parlay for {sport}",
      "{sport} player props with {metric} trending up",
      "Best {sport} bets for {time_period}"
    ];
    
    // Randomly select and enhance prompts
    const shuffled = [...allPrompts].sort(() => 0.5 - Math.random());
    return shuffled.slice(0, 8).map(prompt => {
      // Replace placeholders with actual values
      return prompt
        .replace('{sport}', ['NBA', 'NFL', 'MLB', 'NHL'][Math.floor(Math.random() * 4)])
        .replace('{condition}', ['hot streak', 'favorable matchup', 'home advantage', 'rest advantage'][Math.floor(Math.random() * 4)])
        .replace('{number}', Math.floor(2 + Math.random() * 3))
        .replace('{metric}', ['usage rate', 'target share', 'hard-hit%', 'shot volume'][Math.floor(Math.random() * 4)])
        .replace('{time_period}', ['tonight', 'this weekend', 'tomorrow', 'next week'][Math.floor(Math.random() * 4)]);
    });
  };

  const [usefulPrompts, setUsefulPrompts] = useState([]);

  // Initialize random prompts
  useEffect(() => {
    setUsefulPrompts(getRandomPrompts());
  }, []);

  // Updated sports with enhanced colors
  const sports = [
    { id: 'All', name: 'All Sports', icon: 'grid', color: '#8b5cf6', gradient: ['#8b5cf6', '#7c3aed'] },
    { id: 'NBA', name: 'NBA', icon: 'basketball', color: '#ef4444', gradient: ['#ef4444', '#dc2626'] },
    { id: 'NFL', name: 'NFL', icon: 'american-football', color: '#3b82f6', gradient: ['#3b82f6', '#1d4ed8'] },
    { id: 'NHL', name: 'NHL', icon: 'ice-cream', color: '#1e40af', gradient: ['#1e40af', '#1e3a8a'] },
    { id: 'MLB', name: 'MLB', icon: 'baseball', color: '#10b981', gradient: ['#10b981', '#059669'] },
  ];

  // Enhanced mock picks data with dual analysis
  const mockPicks = [
    {
      id: '1',
      player: 'Stephen Curry',
      team: 'GSW',
      sport: 'NBA',
      pick: 'Over 31.5 Points',
      confidence: 92,
      odds: '-120',
      edge: '+5.2%',
      analysis: 'Advanced: Averaging 34.2 points (115% of prop) in last 5 games. Facing 28th ranked perimeter defense allowing 118.4 PPG. Usage rate at 32.8% with +12% efficiency in similar matchups.',
      simpleAnalysis: 'Easy Explanation: Curry is on fire lately, and he\'s playing against a weak defense that gives up lots of points. Great chance he scores more than 31 tonight.',
      timestamp: 'Today, 2:30 PM',
      category: 'High Probability',
      probability: '92%',
      roi: '+24%',
      units: '2.5',
      requiresPremium: false,
    },
    {
      id: '2',
      player: 'Patrick Mahomes',
      team: 'KC',
      sport: 'NFL',
      pick: 'Over 285.5 Passing Yards',
      confidence: 88,
      odds: '-110',
      edge: '+4.8%',
      analysis: 'Advanced: Defense allows 280.3 passing YPG (29th). Mahomes averaging 298.2 YPG last 4. 88% model confidence based on coverage schemes vs Chiefs spread offense.',
      simpleAnalysis: 'Easy Explanation: The defense Mahomes is facing gives up lots of passing yards. He usually throws for around 300 yards against teams like this.',
      timestamp: 'Today, 1:45 PM',
      category: 'Value Bet',
      probability: '88%',
      roi: '+18%',
      units: '2.0',
      requiresPremium: true,
    },
    {
      id: '3',
      player: 'Shohei Ohtani',
      team: 'LAD',
      sport: 'MLB',
      pick: 'Over 1.5 Total Bases',
      confidence: 83,
      odds: '+110',
      edge: '+4.2%',
      analysis: 'Advanced: Facing RHP with 5.12 ERA, 1.43 WHIP. Ohtani batting .342/.418/.654 vs right-handers. Hard-hit rate 48.7% (Top 5%). Weather: 72¬∞F, wind 8mph out to CF.',
      simpleAnalysis: 'Easy Explanation: Ohtani hits really well against right-handed pitchers, and this particular pitcher has been struggling. Good chance for extra bases.',
      timestamp: 'Today, 10:30 AM',
      category: 'High Probability',
      probability: '83%',
      roi: '+19%',
      units: '2.2',
      requiresPremium: true,
    },
  ];

  // Enhanced prediction generation with 2-free limit
  const generateHighProbabilityPicks = async (prompt) => {
    if (!prompt.trim()) {
      Alert.alert('Error', 'Please enter a prompt to generate predictions');
      return;
    }

    // Check for Success Metrics access first
    const customerInfo = await Purchases.getCustomerInfo();
    if (!customerInfo.entitlements.active?.success_metrics_access) {
      Alert.alert(
        'Success Metrics Required',
        'This feature requires Success Metrics subscription.',
        [
          { text: 'Cancel', style: 'cancel' },
          { 
            text: 'Subscribe', 
            onPress: () => handleNavigateToPremium() // FIXED: Use helper method
          }
        ]
      );
      return;
    }

    // Use 2-free predictions system
    const result = await predictionCounter.usePrediction();
    
    if (result.allowed) {
      // Generate predictions
      setGenerating(true);
      setShowGeneratingModal(true);
      setSelectedPrompt(prompt);
      
      await logEvent('predictions_generation_start', {
        prompt: prompt,
        sport: selectedSport,
        premium: false,
      });
      
      try {
        // Simulate AI processing delay
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Generate picks based on the prompt
        const generatedPicks = generatePicksBasedOnPrompt(prompt);
        
        // Add generated picks to the existing picks
        const updatedPicks = [...generatedPicks, ...picks];
        setPicks(updatedPicks);
        
        // Update filtered picks
        const filtered = selectedSport === 'All' 
          ? updatedPicks 
          : updatedPicks.filter(pick => pick.sport === selectedSport);
        setFilteredPicks(filtered);
        
        await logEvent('predictions_generation_success', {
          prompt: prompt,
          count: generatedPicks.length,
          sport: selectedSport,
          remaining: result.remaining,
        });
        
        // Show success for 2 seconds before closing
        setTimeout(() => {
          setShowGeneratingModal(false);
          setGenerating(false);
          setCustomPrompt('');
        }, 2000);
        
      } catch (error) {
        console.error('Error generating picks:', error);
        await logEvent('predictions_generation_error', {
          error: error.message,
          prompt: prompt,
        });
        Alert.alert('Error', 'Failed to generate predictions. Please try again.');
        setGenerating(false);
        setShowGeneratingModal(false);
      }
    } else {
      if (result.reason === 'limit_reached') {
        // Show upsell for $3.99 prediction pack
        Alert.alert(
          'Daily Limit Reached',
          `${result.message}\n\nGet 5 more predictions for $3.99?`,
          [
            { text: 'Not Now', style: 'cancel' },
            {
              text: 'Buy Pack',
              onPress: async () => {
                const purchaseResult = await predictionCounter.purchasePredictionPack();
                if (purchaseResult.success) {
                  Alert.alert('Success', purchaseResult.message);
                  // Retry generation after purchase
                  generateHighProbabilityPicks(prompt);
                } else {
                  Alert.alert('Error', purchaseResult.message);
                }
              }
            }
          ]
        );
      } else {
        Alert.alert('Error', result.message);
      }
    }
  };

  // Enhanced pick generation with dual analysis
  const generatePicksBasedOnPrompt = (prompt) => {
    const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const now = Date.now();
    
    // Generate advanced and simple analysis
    const generateDualAnalysis = (sport, player, prop) => {
      const advancedAnalyses = [
        `Advanced: Model projects +${Math.floor(5 + Math.random() * 10)}% above prop based on ${['historical trends', 'matchup data', 'player efficiency', 'game script'][Math.floor(Math.random() * 4)]}. ${sport === 'NBA' ? 'Usage rate trending at ' + Math.floor(25 + Math.random() * 15) + '%' : ''}`,
        `Advanced: ${Math.floor(80 + Math.random() * 15)}% statistical confidence. ${['Favorable pace matchup', 'Weak defensive rating', 'Positive situational context', 'High volume opportunity'][Math.floor(Math.random() * 4)]}. Metrics indicate ${Math.floor(5 + Math.random() * 8)}% edge vs market.`,
        `Advanced: Machine learning model identifies ${Math.floor(6 + Math.random() * 8)}% value opportunity. Based on ${Math.floor(15 + Math.random() * 25)} similar historical matchups with ${Math.floor(70 + Math.random() * 20)}% success rate.`
      ];
      
      const simpleAnalyses = [
        `Easy Explanation: ${player} has been playing really well recently, and the matchup looks good for this bet to hit.`,
        `Easy Explanation: The numbers show this is a smart pick. ${player} usually does well in games like this.`,
        `Easy Explanation: Good value here. ${player}'s recent form and the game situation make this a solid choice.`
      ];
      
      return {
        advanced: advancedAnalyses[Math.floor(Math.random() * advancedAnalyses.length)],
        simple: simpleAnalyses[Math.floor(Math.random() * simpleAnalyses.length)]
      };
    };
    
    // Generate 1-2 picks based on prompt
    const pickCount = prompt.toLowerCase().includes('parlay') ? 3 : 1 + Math.floor(Math.random() * 2);
    const generatedPicks = [];
    
    for (let i = 0; i < pickCount; i++) {
      const sport = selectedSport === 'All' ? ['NBA', 'NFL', 'MLB'][Math.floor(Math.random() * 3)] : selectedSport;
      const players = {
        NBA: ['LeBron James', 'Stephen Curry', 'Kevin Durant', 'Giannis Antetokounmpo', 'Jayson Tatum'],
        NFL: ['Patrick Mahomes', 'Josh Allen', 'Justin Jefferson', 'Travis Kelce', 'Christian McCaffrey'],
        MLB: ['Shohei Ohtani', 'Aaron Judge', 'Ronald Acu√±a Jr.', 'Mookie Betts', 'Bryce Harper'],
        NHL: ['Connor McDavid', 'Nathan MacKinnon', 'Auston Matthews', 'Leon Draisaitl', 'David Pastr≈à√°k']
      };
      
      const player = players[sport]?.[Math.floor(Math.random() * players[sport].length)] || 'AI Generated Player';
      const team = sport === 'NBA' ? 'LAL' : sport === 'NFL' ? 'KC' : sport === 'MLB' ? 'LAD' : 'AI';
      const confidence = Math.floor(80 + Math.random() * 15);
      const odds = Math.random() > 0.5 ? `-${Math.floor(110 + Math.random() * 40)}` : `+${Math.floor(100 + Math.random() * 150)}`;
      const edge = `+${(3 + Math.random() * 4).toFixed(1)}%`;
      
      const analysis = generateDualAnalysis(sport, player, 'prop');
      
      generatedPicks.push({
        id: `gen-${now}-${i + 1}`,
        player,
        team,
        sport,
        pick: `Generated ${sport} Prediction`,
        confidence,
        odds,
        edge,
        analysis: analysis.advanced,
        simpleAnalysis: analysis.simple,
        timestamp: `AI Generated (${timestamp})`,
        category: 'AI Generated',
        probability: `${confidence}%`,
        roi: `+${Math.floor(15 + Math.random() * 15)}%`,
        units: (1.5 + Math.random() * 1.5).toFixed(1),
        generatedFrom: prompt,
        requiresPremium: false,
      });
    }
    
    return generatedPicks;
  };

  // Navigation menu component - UPDATED with fixed navigation methods
  const renderNavigationMenu = () => (
    <View style={styles.navigationMenu}>
      <TouchableOpacity 
        style={styles.navButton}
        onPress={() => handleNavigateToExpertSelections()}
        activeOpacity={0.7}
      >
        <View style={[styles.navButtonContent, { backgroundColor: '#10b981' }]}>
          <Ionicons name="trophy" size={20} color="#fff" />
          <Text style={styles.navButtonText}>Expert</Text>
        </View>
      </TouchableOpacity>
      
      <TouchableOpacity 
        style={styles.navButton}
        onPress={() => handleNavigateToPlayerMetrics()}
        activeOpacity={0.7}
      >
        <View style={[styles.navButtonContent, { backgroundColor: '#8b5cf6' }]}>
          <Ionicons name="stats-chart" size={20} color="#fff" />
          <Text style={styles.navButtonText}>Metrics</Text>
        </View>
      </TouchableOpacity>
      
      <TouchableOpacity 
        style={styles.navButton}
        onPress={() => handleNavigateToParlayBuilder()}
        activeOpacity={0.7}
      >
        <View style={[styles.navButtonContent, { backgroundColor: '#3b82f6' }]}>
          <Ionicons name="git-merge" size={20} color="#fff" />
          <Text style={styles.navButtonText}>Parlay</Text>
        </View>
      </TouchableOpacity>
      
      <TouchableOpacity 
        style={styles.navButton}
        onPress={() => handleNavigateToAnalytics()}
        activeOpacity={0.7}
      >
        <View style={[styles.navButtonContent, { backgroundColor: '#f59e0b' }]}>
          <Ionicons name="analytics" size={20} color="#fff" />
          <Text style={styles.navButtonText}>Analytics</Text>
        </View>
      </TouchableOpacity>
    </View>
  );

  useEffect(() => {
    loadPicks();
    logEvent('predictions_screen_view', { sport: selectedSport });
  }, [selectedSport]);

  const loadPicks = async () => {
    try {
      setLoading(true);
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const filteredPicks = selectedSport === 'All' 
        ? mockPicks 
        : mockPicks.filter(pick => pick.sport === selectedSport);
      
      setPicks(filteredPicks);
      setFilteredPicks(filteredPicks);
    } catch (error) {
      console.error('Error loading picks:', error);
      Alert.alert('Error', 'Failed to load predictions. Please try again.');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  const onRefresh = async () => {
    setRefreshing(true);
    await loadPicks();
    // Refresh prompts on pull-to-refresh
    setUsefulPrompts(getRandomPrompts());
    logEvent('predictions_refresh', { sport: selectedSport });
  };

  const handlePredictionsSearch = (query) => {
    setSearchQuery(query);
    addToSearchHistory(query);
    
    if (!query.trim()) {
      setFilteredPicks(picks);
      return;
    }

    const lowerQuery = query.toLowerCase();
    
    const filtered = picks.filter(pick =>
      (pick.player || '').toLowerCase().includes(lowerQuery) ||
      (pick.team || '').toLowerCase().includes(lowerQuery) ||
      (pick.sport || '').toLowerCase().includes(lowerQuery) ||
      (pick.pick || '').toLowerCase().includes(lowerQuery) ||
      (pick.category || '').toLowerCase().includes(lowerQuery)
    );
    
    setFilteredPicks(filtered);
    logEvent('predictions_search', {
      query: query,
      results_count: filtered.length,
    });
  };

  useEffect(() => {
    if (!searchQuery.trim()) {
      setFilteredPicks(picks);
    } else {
      const lowerQuery = searchQuery.toLowerCase();
      const filtered = picks.filter(pick =>
        (pick.player || '').toLowerCase().includes(lowerQuery) ||
        (pick.team || '').toLowerCase().includes(lowerQuery) ||
        (pick.sport || '').toLowerCase().includes(lowerQuery) ||
        (pick.pick || '').toLowerCase().includes(lowerQuery) ||
        (pick.category || '').toLowerCase().includes(lowerQuery)
      );
      setFilteredPicks(filtered);
    }
  }, [searchQuery, picks]);

  // Enhanced generating modal
  const renderGeneratingModal = () => (
    <Modal
      transparent={true}
      visible={showGeneratingModal}
      animationType="fade"
      onRequestClose={() => setShowGeneratingModal(false)}
    >
      <View style={styles.modalContainer}>
        <View style={styles.modalBackground}>
          <View style={styles.modalContent}>
            {generating ? (
              <>
                <ActivityIndicator size="large" color="#8b5cf6" />
                <Text style={styles.modalTitle}>Generating AI Predictions...</Text>
                <Text style={styles.modalSubtitle}>"{selectedPrompt}"</Text>
                
                <View style={styles.processingSteps}>
                  <View style={styles.stepContainer}>
                    <View style={[styles.stepIcon, styles.stepActive]}>
                      <Ionicons name="analytics" size={20} color="white" />
                    </View>
                    <Text style={styles.stepText}>Analyzing Data</Text>
                  </View>
                  <View style={styles.stepLine} />
                  <View style={styles.stepContainer}>
                    <View style={[styles.stepIcon, selectedPrompt.includes('Analyzing') && styles.stepActive]}>
                      <Ionicons name="trending-up" size={20} color="white" />
                    </View>
                    <Text style={styles.stepText}>Finding Trends</Text>
                  </View>
                  <View style={styles.stepLine} />
                  <View style={styles.stepContainer}>
                    <View style={styles.stepIcon}>
                      <Ionicons name="checkmark" size={20} color="white" />
                    </View>
                    <Text style={styles.stepText}>Generating</Text>
                  </View>
                </View>
                
                <Text style={styles.modalText}>Processing thousands of data points to find high probability picks</Text>
              </>
            ) : (
              <>
                <View style={styles.successIconContainer}>
                  <Ionicons name="checkmark-circle" size={40} color="white" />
                </View>
                <Text style={styles.modalTitle}>Predictions Generated!</Text>
                <Text style={styles.modalText}>{predictionCounter.remainingPredictions} free predictions left today</Text>
                <TouchableOpacity
                  style={styles.modalButton}
                  onPress={() => setShowGeneratingModal(false)}
                >
                  <Text style={styles.modalButtonText}>View Results</Text>
                </TouchableOpacity>
              </>
            )}
          </View>
        </View>
      </View>
    </Modal>
  );

  // Enhanced prompts section
  const renderPromptsSection = () => (
    <View style={styles.promptsSection}>
      <View style={styles.promptsHeader}>
        <View>
          <Text style={styles.promptsTitle}>üöÄ AI Prediction Generator</Text>
          <Text style={styles.promptsSubtitle}>
            {predictionCounter.remainingPredictions} free predictions remaining today
          </Text>
        </View>
        <TouchableOpacity 
          style={styles.refreshPromptsButton}
          onPress={() => setUsefulPrompts(getRandomPrompts())}
        >
          <Ionicons name="refresh" size={20} color="#8b5cf6" />
        </TouchableOpacity>
      </View>
      
      <Text style={styles.promptsHint}>Tap any suggestion below:</Text>
      <ScrollView 
        horizontal 
        showsHorizontalScrollIndicator={false}
        style={styles.promptsScroll}
      >
        {usefulPrompts.map((prompt, index) => (
          <TouchableOpacity
            key={`prompt-${index}`}
            style={styles.promptChip}
            onPress={() => generateHighProbabilityPicks(prompt)}
            disabled={generating}
          >
            <View style={styles.promptChipContent}>
              <Ionicons name="sparkles" size={14} color="#fff" />
              <Text style={styles.promptChipText}>{prompt}</Text>
            </View>
          </TouchableOpacity>
        ))}
      </ScrollView>
      
      <View style={styles.customPromptContainer}>
        <View style={styles.promptInputContainer}>
          <Ionicons name="create" size={20} color="#8b5cf6" />
          <TextInput
            style={styles.promptInput}
            placeholder="Or type your own prompt (e.g., 'NFL parlay for tonight')"
            placeholderTextColor="#94a3b8"
            value={customPrompt}
            onChangeText={setCustomPrompt}
            multiline
            numberOfLines={2}
            editable={!generating}
          />
        </View>
        <TouchableOpacity
          style={[styles.generateButton, (!customPrompt.trim() || generating) && styles.generateButtonDisabled]}
          onPress={() => customPrompt.trim() && generateHighProbabilityPicks(customPrompt)}
          disabled={!customPrompt.trim() || generating}
        >
          <View style={styles.generateButtonContent}>
            {generating ? (
              <ActivityIndicator size="small" color="white" />
            ) : (
              <>
                <Ionicons name="rocket" size={16} color="white" />
                <Text style={styles.generateButtonText}>Generate</Text>
              </>
            )}
          </View>
        </TouchableOpacity>
      </View>
      
      <View style={styles.promptsFooter}>
        <Ionicons name="information-circle" size={14} color="#8b5cf6" />
        <Text style={styles.promptsFooterText}>
          Uses advanced AI to analyze trends and generate high probability predictions
        </Text>
      </View>
    </View>
  );

  const renderPickItem = ({ item }) => {
    const isPremiumLocked = item.requiresPremium && !daily.hasAccess;
    const currentAnalysis = showSimpleAnalysis ? item.simpleAnalysis : item.analysis;
    
    return (
      <View style={styles.pickCard}>
        <View style={styles.pickCardContent}>
          <View style={styles.pickHeader}>
            <View style={styles.playerInfo}>
              <View>
                <Text style={styles.playerName}>{item.player}</Text>
                <View style={styles.pickSubheader}>
                  <Text style={styles.teamText}>{item.team}</Text>
                  <View style={styles.sportBadgeContainer}>
                    <View style={[styles.sportBadge, getSportBadgeStyle(item.sport)]}>
                      <Text style={[styles.sportText, getSportTextStyle(item.sport)]}>
                        {item.sport}
                      </Text>
                    </View>
                  </View>
                </View>
              </View>
              {item.category && (
                <View style={styles.categoryContainer}>
                  <View style={[styles.categoryBadge, getCategoryStyle(item.category)]}>
                    <Text style={[styles.categoryText, getCategoryTextStyle(item.category)]}>
                      {item.category}
                    </Text>
                  </View>
                </View>
              )}
            </View>
            <View style={styles.confidenceBadgeContainer}>
              <View style={[styles.confidenceBadge, getConfidenceStyle(item.confidence)]}>
                <Text style={styles.confidenceText}>{item.confidence}%</Text>
              </View>
            </View>
          </View>
          
          <View style={styles.pickDetails}>
            <Text style={[styles.pickValue, isPremiumLocked && styles.premiumLockedText]}>
              {item.pick}
            </Text>
            <View style={styles.pickMeta}>
              <View style={styles.oddsContainer}>
                <Text style={styles.oddsLabel}>Odds:</Text>
                <Text style={styles.oddsText}>{item.odds}</Text>
              </View>
              <View style={styles.edgeContainer}>
                <Ionicons name="trending-up" size={14} color="#10b981" />
                <Text style={styles.edgeText}>{item.edge} edge</Text>
              </View>
            </View>
          </View>
          
          {item.probability && (
            <View style={styles.probabilityMetrics}>
              <View style={styles.metricItem}>
                <Ionicons name="stats-chart" size={14} color="#8b5cf6" />
                <Text style={styles.metricLabel}>Win Chance</Text>
                <Text style={styles.metricValue}>{item.probability}</Text>
              </View>
              <View style={styles.metricItem}>
                <Ionicons name="cash" size={14} color="#10b981" />
                <Text style={styles.metricLabel}>Projected ROI</Text>
                <Text style={styles.metricValue}>{item.roi}</Text>
              </View>
              <View style={styles.metricItem}>
                <Ionicons name="trophy" size={14} color="#f59e0b" />
                <Text style={styles.metricLabel}>Units</Text>
                <Text style={styles.metricValue}>{item.units}</Text>
              </View>
            </View>
          )}
          
          <View style={styles.analysisContainer}>
            <View style={styles.analysisHeader}>
              <Ionicons name="analytics" size={16} color="#f59e0b" />
              <Text style={styles.analysisTitle}>
                {showSimpleAnalysis ? 'Simple Explanation' : 'Advanced Analysis'}
              </Text>
              <TouchableOpacity
                style={styles.analysisToggle}
                onPress={() => setShowSimpleAnalysis(!showSimpleAnalysis)}
              >
                <Text style={styles.analysisToggleText}>
                  {showSimpleAnalysis ? 'Advanced' : 'Simple'}
                </Text>
                <Ionicons 
                  name={showSimpleAnalysis ? "arrow-up" : "arrow-down"} 
                  size={12} 
                  color="#8b5cf6" 
                />
              </TouchableOpacity>
            </View>
            <Text style={[styles.analysisText, isPremiumLocked && styles.premiumLockedText]}>
              {isPremiumLocked ? 'üîí Premium prediction analysis available with upgrade' : currentAnalysis}
            </Text>
          </View>
          
          {item.generatedFrom && (
            <View style={styles.generatedInfo}>
              <Ionicons name="sparkles" size={12} color="#8b5cf6" />
              <Text style={styles.generatedText}>
                Generated from: "{item.generatedFrom.substring(0, 50)}..."
              </Text>
            </View>
          )}
          
          <View style={styles.footer}>
            <Text style={styles.timestamp}>{item.timestamp}</Text>
            <TouchableOpacity 
              style={[styles.trackButton, isPremiumLocked && styles.premiumTrackButton]}
              onPress={() => {
                if (isPremiumLocked) {
                  Alert.alert(
                    'Premium Prediction',
                    'This prediction requires premium access.',
                    [
                      { text: 'Cancel', style: 'cancel' },
                      { 
                        text: 'Upgrade', 
                        onPress: () => handleNavigateToPremium() // FIXED: Use helper method
                      }
                    ]
                  );
                  return;
                }
                
                logEvent('predictions_track_pick', {
                  player: item.player,
                  pick: item.pick,
                  confidence: item.confidence,
                });
                Alert.alert('Tracking Started', `${item.player}'s prediction has been added to your tracked picks.`);
              }}
            >
              {isPremiumLocked ? (
                <>
                  <Ionicons name="lock-closed" size={16} color="#f59e0b" />
                  <Text style={styles.premiumTrackButtonText}>Unlock</Text>
                </>
              ) : (
                <>
                  <Ionicons name="bookmark-outline" size={16} color="#8b5cf6" />
                  <Text style={styles.trackButtonText}>Track</Text>
                </>
              )}
            </TouchableOpacity>
          </View>
        </View>
      </View>
    );
  };

  const renderSearchBar = () => {
    if (!showSearch) return null;

    return (
      <>
        <SearchBar
          placeholder="Search predictions by player, team, or sport..."
          onSearch={handlePredictionsSearch}
          searchHistory={searchHistory}
          style={styles.homeSearchBar}
          onClose={() => {
            setShowSearch(false);
            setSearchQuery('');
          }}
        />
        
        {searchQuery.trim() && picks.length !== filteredPicks.length && (
          <View style={styles.searchResultsInfo}>
            <Text style={styles.searchResultsText}>
              {filteredPicks.length} of {picks.length} predictions match "{searchQuery}"
            </Text>
            <TouchableOpacity 
              onPress={() => setSearchQuery('')}
              activeOpacity={0.7}
            >
              <Text style={styles.clearSearchText}>Clear</Text>
            </TouchableOpacity>
          </View>
        )}
      </>
    );
  };

  const renderFloatingSearchButton = () => (
    <TouchableOpacity
      style={styles.floatingSearchButton}
      onPress={async () => {
        await logEvent('predictions_search_toggle', {
          action: 'open_search',
        });
        setShowSearch(true);
      }}
      activeOpacity={0.7}
    >
      <View style={styles.floatingSearchContent}>
        <Ionicons name="search" size={24} color="white" />
      </View>
    </TouchableOpacity>
  );

  // Advanced Analytics Tips Section
  const renderAdvancedAnalyticsTips = () => (
    <View style={styles.analyticsTipsSection}>
      <View style={styles.analyticsHeader}>
        <Ionicons name="analytics" size={24} color="#8b5cf6" />
        <Text style={styles.analyticsTitle}>Advanced Analytics Tips</Text>
      </View>
      
      <View style={styles.tipsGrid}>
        {advancedAnalytics.slice(0, 4).map((tip, index) => (
          <View key={index} style={styles.tipCard}>
            <Ionicons name="checkmark-circle" size={16} color="#10b981" />
            <Text style={styles.tipText}>{tip}</Text>
          </View>
        ))}
      </View>
      
      <TouchableOpacity 
        style={styles.moreTipsButton}
        onPress={() => {
          // Rotate tips
          const shuffled = [...advancedAnalytics].sort(() => 0.5 - Math.random());
          setAdvancedAnalytics(shuffled);
        }}
      >
        <Text style={styles.moreTipsText}>Show Different Tips</Text>
      </TouchableOpacity>
      
      <View style={styles.parlayTip}>
        <Ionicons name="git-merge" size={18} color="#f59e0b" />
        <Text style={styles.parlayTipText}>
          üí° Pro Tip: For parlays, try prompts like "3-leg parlay tonight" or combine sports with "MLB + NBA picks"
        </Text>
      </View>
    </View>
  );

  if (predictionCounter.isLoading || loading) {
    return (
      <View style={styles.centerContainer}>
        <ActivityIndicator size="large" color="#8b5cf6" />
        <Text style={styles.loadingText}>Loading AI Predictions...</Text>
      </View>
    );
  }

  return (
    <SafeAreaView style={styles.container}>
      {/* Header */}
      <View style={styles.header}>
        <View style={styles.headerOverlay}>
          <View style={styles.headerTop}>
            <TouchableOpacity 
              style={styles.backButton}
              onPress={() => navigation.goBack()}
            >
              <Ionicons name="arrow-back" size={24} color="white" />
            </TouchableOpacity>
            
            <TouchableOpacity 
              style={styles.headerSearchButton}
              onPress={async () => {
                await logEvent('predictions_search_toggle', {
                  action: 'open_search',
                });
                setShowSearch(true);
              }}
            >
              <Ionicons name="search-outline" size={20} color="white" />
            </TouchableOpacity>
          </View>
        </View>
      </View>

      {/* NEW: Compact GPT-Powered Predictions Title */}
      <View style={styles.compactTitleContainer}>
        <View style={styles.compactTitleRow}>
          <View style={styles.gptBadge}>
            <Ionicons name="sparkles" size={14} color="white" />
            <Text style={styles.gptBadgeText}>GPT</Text>
          </View>
          <Text style={styles.compactMainTitle}>Predictions</Text>
        </View>
        <Text style={styles.compactSubtitle}>AI-Powered Sports Analytics</Text>
      </View>

      {/* Prediction Counter */}
      <View style={styles.predictionCounter}>
        <View style={styles.counterContent}>
          <Ionicons name="flash" size={16} color="white" />
          <Text style={styles.counterText}>
            {predictionCounter.remainingPredictions}/2 Free Today
          </Text>
        </View>
      </View>

      {/* Add navigation menu */}
      <View style={styles.navigationMenuContainer}>
        {renderNavigationMenu()}
      </View>

      <View style={styles.disclaimer}>
        <Ionicons name="information-circle" size={16} color="rgba(255,255,255,0.8)" />
        <Text style={styles.disclaimerText}>For analysis and prediction purposes only</Text>
      </View>

      <ScrollView
        refreshControl={
          <RefreshControl
            refreshing={refreshing}
            onRefresh={onRefresh}
            colors={['#8b5cf6']}
            tintColor="#8b5cf6"
          />
        }
      >
        {renderSearchBar()}
        
        {/* Sport Selector */}
        <View style={styles.sportSelector}>
          {sports.map((sport) => (
            <TouchableOpacity
              key={sport.id}
              style={[
                styles.sportButton,
                selectedSport === sport.id && styles.sportButtonActive,
              ]}
              onPress={() => setSelectedSport(sport.id)}
            >
              {selectedSport === sport.id ? (
                <View style={[styles.sportButtonContent, { backgroundColor: sport.gradient[0] }]}>
                  <Ionicons 
                    name={sport.icon} 
                    size={20} 
                    color="#fff" 
                  />
                  <Text style={styles.sportButtonTextActive}>
                    {sport.name}
                  </Text>
                </View>
              ) : (
                <>
                  <Ionicons 
                    name={sport.icon} 
                    size={20} 
                    color="#6b7280" 
                  />
                  <Text style={styles.sportButtonText}>
                    {sport.name}
                  </Text>
                </>
              )}
            </TouchableOpacity>
          ))}
        </View>

        {/* Generate Predictions Section */}
        {renderPromptsSection()}

        {/* Performance Stats */}
        <View style={styles.statsSection}>
          <Text style={styles.sectionTitle}>üìà Prediction Performance</Text>
          <View style={styles.statsGrid}>
            <View style={[styles.statBox, { backgroundColor: '#8b5cf6' }]}>
              <Text style={styles.statNumber}>87.3%</Text>
              <Text style={styles.statLabel}>Hit Rate</Text>
            </View>
            <View style={[styles.statBox, { backgroundColor: '#10b981' }]}>
              <Text style={styles.statNumber}>+24.8%</Text>
              <Text style={styles.statLabel}>ROI</Text>
            </View>
            <View style={[styles.statBox, { backgroundColor: '#3b82f6' }]}>
              <Text style={styles.statNumber}>15-3</Text>
              <Text style={styles.statLabel}>Last 18 Picks</Text>
            </View>
            <View style={[styles.statBox, { backgroundColor: '#f59e0b' }]}>
              <Text style={styles.statNumber}>4.2‚≠ê</Text>
              <Text style={styles.statLabel}>Avg Edge</Text>
            </View>
          </View>
        </View>

        {/* Advanced Analytics Tips */}
        {renderAdvancedAnalyticsTips()}

        {/* Today's Predictions */}
        <View style={styles.picksSection}>
          <View style={styles.sectionHeader}>
            <View>
              <Text style={styles.sectionTitle}>üéØ Today's Top Predictions</Text>
              <Text style={styles.pickCount}>
                {filteredPicks.length} predictions ‚Ä¢ {predictionCounter.remainingPredictions} free left today
              </Text>
            </View>
            {!daily.hasAccess && filteredPicks.some(p => p.requiresPremium) && (
              <TouchableOpacity 
                style={styles.premiumBadgeHeader}
                onPress={() => handleNavigateToPremium()} // FIXED: Use helper method
              >
                <Ionicons name="lock-open" size={14} color="#f59e0b" />
                <Text style={styles.premiumBadgeHeaderText}>Unlock All</Text>
              </TouchableOpacity>
            )}
          </View>
          
          {filteredPicks.length > 0 ? (
            <FlatList
              data={filteredPicks}
              renderItem={renderPickItem}
              keyExtractor={item => `pick-${item.id}-${item.sport}`}
              scrollEnabled={false}
              contentContainerStyle={styles.picksList}
            />
          ) : (
            <View style={styles.emptyContainer}>
              <Ionicons name="search-outline" size={48} color="#8b5cf6" />
              {searchQuery.trim() ? (
                <>
                  <Text style={styles.emptyText}>No predictions found</Text>
                  <Text style={styles.emptySubtext}>Try a different search term or sport</Text>
                </>
              ) : (
                <>
                  <Text style={styles.emptyText}>No predictions available</Text>
                  <Text style={styles.emptySubtext}>Generate some predictions above!</Text>
                </>
              )}
              <TouchableOpacity 
                style={styles.generateEmptyButton}
                onPress={() => generateHighProbabilityPicks('Generate predictions for me')}
                disabled={generating}
              >
                <View style={styles.generateEmptyButtonContent}>
                  <Ionicons name="sparkles" size={16} color="white" />
                  <Text style={styles.generateEmptyButtonText}>
                    {generating ? 'Generating...' : 'Generate Predictions'}
                  </Text>
                </View>
              </TouchableOpacity>
            </View>
          )}
        </View>
      </ScrollView>
      
      {!showSearch && renderFloatingSearchButton()}
      {renderGeneratingModal()}
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  // Updated styles with bolder, more appealing design
  container: {
    flex: 1,
    backgroundColor: '#0f172a',
  },
  
  centerContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#0f172a',
  },
  
  loadingText: {
    marginTop: 15,
    fontSize: 18,
    color: '#cbd5e1',
    fontWeight: '600',
  },
  
  // Header styles - Updated for better layout
  header: {
    paddingHorizontal: 16,
    paddingTop: Platform.OS === 'ios' ? 60 : 40,
    paddingBottom: 10,
    borderBottomLeftRadius: 25,
    borderBottomRightRadius: 25,
    backgroundColor: '#8b5cf6',
  },
  
  headerOverlay: {
    flex: 1,
    backgroundColor: 'transparent',
  },
  
  headerTop: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 10,
  },
  
  backButton: {
    padding: 8,
    backgroundColor: 'rgba(255,255,255,0.15)',
    borderRadius: 20,
    width: 40,
    height: 40,
    justifyContent: 'center',
    alignItems: 'center',
  },
  
  headerSearchButton: {
    padding: 8,
    backgroundColor: 'rgba(255,255,255,0.2)',
    borderRadius: 20,
    width: 40,
    height: 40,
    justifyContent: 'center',
    alignItems: 'center',
  },
  
  // NEW: Compact Title Styles - Updated for better visibility
  compactTitleContainer: {
    backgroundColor: '#ffffff',
    padding: 16,
    borderRadius: 16,
    marginHorizontal: 20,
    marginTop: 10,
    marginBottom: 15,
    borderWidth: 1,
    borderColor: 'rgba(139, 92, 246, 0.2)',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 3,
  },

  compactTitleRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 6,
  },

  gptBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#8b5cf6',
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 20,
    marginRight: 10,
    shadowColor: '#8b5cf6',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.3,
    shadowRadius: 4,
    elevation: 2,
  },

  gptBadgeText: {
    fontSize: 13,
    fontWeight: 'bold',
    color: 'white',
    marginLeft: 4,
  },

  compactMainTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: '#0f172a',
    flex: 1,
  },

  compactSubtitle: {
    fontSize: 14,
    color: '#8b5cf6',
    fontWeight: '600',
    opacity: 0.9,
  },
  
  // Update headerMain to adjust spacing
  headerMain: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 15,
    marginTop: 8,
  },
  
  headerIcon: {
    backgroundColor: 'rgba(255,255,255,0.2)',
    padding: 15,
    borderRadius: 25,
    marginRight: 15,
  },
  
  headerText: {
    flex: 1,
  },
  
  headerTitle: {
    fontSize: 32,
    fontWeight: 'bold',
    color: 'white',
    textShadowColor: 'rgba(0,0,0,0.3)',
    textShadowOffset: { width: 1, height: 1 },
    textShadowRadius: 3,
  },
  
  headerSubtitle: {
    fontSize: 16,
    color: 'white',
    opacity: 0.9,
    marginTop: 5,
    fontWeight: '600',
  },
  
  predictionCounter: {
    marginTop: 5,
    marginHorizontal: 20,
    marginBottom: 15,
    alignItems: 'center',
  },
  
  counterContent: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#8b5cf6',
    paddingHorizontal: 15,
    paddingVertical: 10,
    borderRadius: 20,
    borderWidth: 1,
    borderColor: 'rgba(255,255,255,0.2)',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.2,
    shadowRadius: 4,
    elevation: 2,
  },
  
  counterText: {
    color: 'white',
    fontWeight: 'bold',
    marginLeft: 8,
    fontSize: 14,
  },
  
  // Navigation menu
  navigationMenuContainer: {
    marginHorizontal: 20,
    marginBottom: 15,
    backgroundColor: 'rgba(139, 92, 246, 0.1)',
    borderRadius: 20,
    padding: 12,
    borderWidth: 1,
    borderColor: 'rgba(139, 92, 246, 0.2)',
  },
  
  navigationMenu: {
    flexDirection: 'row',
    justifyContent: 'space-around',
  },
  
  navButton: {
    alignItems: 'center',
    flex: 1,
    marginHorizontal: 4,
  },
  
  navButtonContent: {
    paddingHorizontal: 12,
    paddingVertical: 10,
    borderRadius: 15,
    alignItems: 'center',
    width: '100%',
  },
  
  navButtonText: {
    color: 'white',
    fontSize: 11,
    marginTop: 4,
    fontWeight: 'bold',
  },
  
  disclaimer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: 'rgba(139, 92, 246, 0.1)',
    padding: 10,
    borderRadius: 10,
    marginHorizontal: 20,
    marginBottom: 15,
    justifyContent: 'center',
    borderWidth: 1,
    borderColor: 'rgba(139, 92, 246, 0.2)',
  },
  
  disclaimerText: {
    fontSize: 12,
    color: '#8b5cf6',
    marginLeft: 8,
    fontWeight: '500',
  },
  
  // Sport Selector
  sportSelector: {
    flexDirection: 'row',
    justifyContent: 'center',
    margin: 20,
    backgroundColor: '#1e293b',
    borderRadius: 20,
    padding: 10,
    elevation: 5,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.2,
    shadowRadius: 8,
  },
  
  sportButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 15,
    paddingVertical: 12,
    borderRadius: 15,
    marginHorizontal: 5,
    flex: 1,
    justifyContent: 'center',
    backgroundColor: '#0f172a',
  },
  
  sportButtonActive: {
    backgroundColor: 'transparent',
  },
  
  sportButtonContent: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 15,
    paddingVertical: 12,
    borderRadius: 15,
    width: '100%',
    justifyContent: 'center',
  },
  
  sportButtonText: {
    fontSize: 14,
    fontWeight: '600',
    color: '#94a3b8',
    marginLeft: 8,
  },
  
  sportButtonTextActive: {
    fontSize: 14,
    fontWeight: 'bold',
    color: 'white',
    marginLeft: 8,
  },
  
  // Prompts Section
  promptsSection: {
    marginHorizontal: 20,
    marginBottom: 25,
    padding: 25,
    borderRadius: 25,
    backgroundColor: '#1e293b',
    elevation: 5,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.2,
    shadowRadius: 8,
  },
  
  promptsHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 15,
  },
  
  promptsTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    color: 'white',
  },
  
  promptsSubtitle: {
    fontSize: 14,
    color: '#cbd5e1',
    marginTop: 4,
    fontWeight: '500',
  },
  
  refreshPromptsButton: {
    backgroundColor: 'rgba(255,255,255,0.1)',
    padding: 10,
    borderRadius: 12,
  },
  
  promptsHint: {
    fontSize: 14,
    color: '#94a3b8',
    marginBottom: 15,
    fontStyle: 'italic',
  },
  
  promptsScroll: {
    marginVertical: 15,
  },
  
  promptChip: {
    marginRight: 15,
    borderRadius: 20,
    elevation: 3,
  },
  
  promptChipContent: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#8b5cf6',
    paddingHorizontal: 18,
    paddingVertical: 12,
    borderRadius: 20,
    minWidth: 220,
  },
  
  promptChipText: {
    fontSize: 13,
    color: 'white',
    fontWeight: '600',
    marginLeft: 8,
    flex: 1,
  },
  
  customPromptContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 20,
  },
  
  promptInputContainer: {
    flex: 1,
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#2d3748',
    borderWidth: 2,
    borderColor: '#334155',
    borderRadius: 15,
    paddingHorizontal: 15,
    paddingVertical: 14,
    marginRight: 15,
  },
  
  promptInput: {
    flex: 1,
    fontSize: 15,
    color: '#f1f5f9',
    marginLeft: 10,
    maxHeight: 60,
    fontWeight: '500',
  },
  
  generateButton: {
    borderRadius: 15,
    elevation: 3,
    minWidth: 140,
  },
  
  generateButtonContent: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: '#8b5cf6',
    paddingHorizontal: 24,
    paddingVertical: 15,
    borderRadius: 15,
  },
  
  generateButtonDisabled: {
    opacity: 0.7,
  },
  
  generateButtonText: {
    color: 'white',
    fontWeight: 'bold',
    fontSize: 15,
    marginLeft: 8,
  },
  
  promptsFooter: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    marginTop: 20,
    paddingTop: 20,
    borderTopWidth: 1,
    borderTopColor: '#334155',
  },
  
  promptsFooterText: {
    fontSize: 13,
    color: '#cbd5e1',
    flex: 1,
    marginLeft: 10,
    lineHeight: 18,
    fontWeight: '500',
  },
  
  // Stats Section
  statsSection: {
    marginHorizontal: 20,
    marginBottom: 25,
    padding: 20,
    borderRadius: 20,
    backgroundColor: '#ffffff',
    elevation: 5,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
  },
  
  sectionTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#0f172a',
    marginBottom: 20,
  },
  
  statsGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
  },
  
  statBox: {
    width: '48%',
    padding: 20,
    borderRadius: 15,
    alignItems: 'center',
    marginBottom: 15,
    elevation: 3,
  },
  
  statNumber: {
    fontSize: 28,
    fontWeight: 'bold',
    color: 'white',
  },
  
  statLabel: {
    fontSize: 14,
    color: 'white',
    marginTop: 8,
    fontWeight: '600',
    opacity: 0.9,
  },
  
  // Analytics Tips Section
  analyticsTipsSection: {
    marginHorizontal: 20,
    marginBottom: 25,
    padding: 25,
    borderRadius: 25,
    backgroundColor: '#1e293b',
    elevation: 5,
  },
  
  analyticsHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 20,
  },
  
  analyticsTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: 'white',
    marginLeft: 12,
  },
  
  tipsGrid: {
    marginBottom: 20,
  },
  
  tipCard: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    backgroundColor: 'rgba(255,255,255,0.05)',
    padding: 15,
    borderRadius: 12,
    marginBottom: 10,
    borderWidth: 1,
    borderColor: 'rgba(255,255,255,0.1)',
  },
  
  tipText: {
    fontSize: 14,
    color: '#cbd5e1',
    flex: 1,
    marginLeft: 10,
    lineHeight: 20,
    fontWeight: '500',
  },
  
  moreTipsButton: {
    alignSelf: 'center',
    paddingVertical: 10,
    paddingHorizontal: 20,
    borderRadius: 10,
    backgroundColor: 'rgba(139, 92, 246, 0.2)',
    borderWidth: 1,
    borderColor: '#8b5cf6',
    marginBottom: 15,
  },
  
  moreTipsText: {
    color: '#8b5cf6',
    fontWeight: '600',
    fontSize: 14,
  },
  
  parlayTip: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    backgroundColor: 'rgba(245, 158, 11, 0.1)',
    padding: 15,
    borderRadius: 12,
    borderWidth: 1,
    borderColor: 'rgba(245, 158, 11, 0.2)',
  },
  
  parlayTipText: {
    fontSize: 14,
    color: '#f59e0b',
    flex: 1,
    marginLeft: 10,
    lineHeight: 20,
    fontWeight: '500',
  },
  
  // Picks Section
  picksSection: {
    marginHorizontal: 20,
    marginBottom: 30,
  },
  
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 20,
  },
  
  pickCount: {
    fontSize: 14,
    color: '#cbd5e1',
    marginTop: 4,
    fontWeight: '500',
  },
  
  premiumBadgeHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#fffbeb',
    paddingHorizontal: 15,
    paddingVertical: 8,
    borderRadius: 20,
    borderWidth: 1,
    borderColor: '#fde68a',
  },
  
  premiumBadgeHeaderText: {
    fontSize: 12,
    fontWeight: '600',
    color: '#92400e',
    marginLeft: 6,
  },
  
  picksList: {
    paddingBottom: 10,
  },
  
  // Pick Card
  pickCard: {
    borderRadius: 20,
    marginBottom: 16,
    backgroundColor: 'white',
    elevation: 5,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    overflow: 'hidden',
  },
  
  pickCardContent: {
    padding: 20,
    backgroundColor: '#ffffff',
  },
  
  pickHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
    marginBottom: 15,
  },
  
  playerInfo: {
    flex: 1,
  },
  
  playerName: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#0f172a',
  },
  
  pickSubheader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 5,
    flexWrap: 'wrap',
  },
  
  teamText: {
    fontSize: 16,
    color: '#475569',
    fontWeight: '500',
    marginRight: 10,
  },
  
  sportBadgeContainer: {
    backgroundColor: 'white',
    borderRadius: 12,
    padding: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.05,
    shadowRadius: 2,
    elevation: 1,
    marginRight: 8,
  },
  
  sportBadge: {
    paddingHorizontal: 6,
    paddingVertical: 2,
    borderRadius: 4,
  },
  
  sportText: {
    fontSize: 11,
    fontWeight: '600',
  },
  
  categoryContainer: {
    marginTop: 8,
  },
  
  categoryBadge: {
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 6,
    alignSelf: 'flex-start',
  },
  
  categoryText: {
    fontWeight: '600',
    fontSize: 10,
  },
  
  confidenceBadgeContainer: {
    backgroundColor: 'white',
    borderRadius: 12,
    padding: 2,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 1 },
    shadowOpacity: 0.05,
    shadowRadius: 2,
    elevation: 1,
  },
  
  confidenceBadge: {
    paddingHorizontal: 15,
    paddingVertical: 8,
    borderRadius: 20,
  },
  
  confidenceText: {
    color: 'white',
    fontSize: 16,
    fontWeight: 'bold',
  },
  
  pickDetails: {
    marginBottom: 15,
  },
  
  pickValue: {
    fontSize: 18,
    fontWeight: 'bold',
    color: '#0f766e',
    marginBottom: 8,
  },
  
  premiumLockedText: {
    color: '#6b7280',
    opacity: 0.7,
  },
  
  pickMeta: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  
  oddsContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  
  oddsLabel: {
    fontSize: 15,
    color: '#475569',
    marginRight: 6,
    fontWeight: '500',
  },
  
  oddsText: {
    fontSize: 16,
    color: '#0f172a',
    fontWeight: 'bold',
  },
  
  edgeContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f0fdf4',
    paddingHorizontal: 12,
    paddingVertical: 6,
    borderRadius: 10,
    borderWidth: 1,
    borderColor: '#10b98130',
  },
  
  edgeText: {
    fontSize: 14,
    color: '#10b981',
    fontWeight: 'bold',
    marginLeft: 4,
  },
  
  probabilityMetrics: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    backgroundColor: '#f8fafc',
    padding: 16,
    borderRadius: 12,
    marginBottom: 15,
    borderWidth: 1,
    borderColor: '#e2e8f0',
  },
  
  metricItem: {
    alignItems: 'center',
    flex: 1,
  },
  
  metricLabel: {
    fontSize: 12,
    color: '#64748b',
    marginTop: 6,
    fontWeight: '500',
  },
  
  metricValue: {
    fontSize: 16,
    fontWeight: 'bold',
    color: '#0f172a',
    marginTop: 3,
  },
  
  analysisContainer: {
    backgroundColor: '#fffbeb',
    padding: 15,
    borderRadius: 12,
    marginBottom: 15,
    borderWidth: 1,
    borderColor: '#f59e0b30',
  },
  
  analysisHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 10,
  },
  
  analysisTitle: {
    fontSize: 14,
    fontWeight: 'bold',
    color: '#92400e',
    marginLeft: 8,
    flex: 1,
  },
  
  analysisToggle: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: 'rgba(139, 92, 246, 0.1)',
    paddingHorizontal: 10,
    paddingVertical: 5,
    borderRadius: 8,
    borderWidth: 1,
    borderColor: 'rgba(139, 92, 246, 0.2)',
  },
  
  analysisToggleText: {
    fontSize: 12,
    color: '#8b5cf6',
    fontWeight: '600',
    marginRight: 6,
  },
  
  analysisText: {
    fontSize: 15,
    color: '#92400e',
    lineHeight: 22,
    fontWeight: '500',
  },
  
  generatedInfo: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#f5f3ff',
    padding: 12,
    borderRadius: 10,
    marginBottom: 15,
    borderWidth: 1,
    borderColor: '#8b5cf630',
  },
  
  generatedText: {
    fontSize: 12,
    color: '#5b21b6',
    flex: 1,
    marginLeft: 8,
    fontStyle: 'italic',
    fontWeight: '500',
  },
  
  footer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  
  timestamp: {
    fontSize: 13,
    color: '#94a3b8',
    fontWeight: '500',
  },
  
  trackButton: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 8,
    borderRadius: 12,
    backgroundColor: 'transparent',
  },
  
  premiumTrackButton: {
    backgroundColor: '#fffbeb',
    borderWidth: 1,
    borderColor: '#fde68a',
  },
  
  trackButtonText: {
    fontSize: 13,
    color: '#8b5cf6',
    fontWeight: 'bold',
    marginLeft: 6,
  },
  
  premiumTrackButtonText: {
    fontSize: 13,
    color: '#92400e',
    fontWeight: 'bold',
    marginLeft: 6,
  },
  
  // Search styles
  homeSearchBar: {
    marginHorizontal: 16,
    marginTop: 20,
    marginBottom: 8,
  },
  
  searchResultsInfo: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingHorizontal: 16,
    paddingVertical: 12,
    backgroundColor: '#1e293b',
    borderBottomWidth: 1,
    borderBottomColor: '#334155',
  },
  
  searchResultsText: {
    fontSize: 14,
    color: '#cbd5e1',
    fontWeight: '500',
  },
  
  clearSearchText: {
    fontSize: 14,
    color: '#8b5cf6',
    fontWeight: 'bold',
  },
  
  floatingSearchButton: {
    position: 'absolute',
    bottom: 30,
    right: 20,
    width: 60,
    height: 60,
    borderRadius: 30,
    backgroundColor: '#8b5cf6',
    elevation: 8,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.3,
    shadowRadius: 5,
    zIndex: 1000,
  },
  
  floatingSearchContent: {
    width: '100%',
    height: '100%',
    borderRadius: 30,
    justifyContent: 'center',
    alignItems: 'center',
  },
  
  // Modal styles
  modalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  
  modalBackground: {
    width: '100%',
    height: '100%',
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0,0,0,0.95)',
  },
  
  modalContent: {
    backgroundColor: 'white',
    borderRadius: 25,
    padding: 30,
    alignItems: 'center',
    width: '85%',
    maxWidth: 400,
    elevation: 10,
  },
  
  modalTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    color: '#0f172a',
    marginTop: 20,
    textAlign: 'center',
  },
  
  modalSubtitle: {
    fontSize: 16,
    color: '#8b5cf6',
    marginTop: 8,
    textAlign: 'center',
    fontWeight: '500',
  },
  
  modalText: {
    fontSize: 15,
    color: '#475569',
    marginTop: 10,
    textAlign: 'center',
    lineHeight: 22,
  },
  
  processingSteps: {
    flexDirection: 'row',
    alignItems: 'center',
    marginVertical: 25,
  },
  
  stepContainer: {
    alignItems: 'center',
  },
  
  stepIcon: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: '#e2e8f0',
    justifyContent: 'center',
    alignItems: 'center',
  },
  
  stepActive: {
    backgroundColor: '#8b5cf6',
  },
  
  stepText: {
    fontSize: 11,
    color: '#64748b',
    marginTop: 5,
    fontWeight: '500',
  },
  
  stepLine: {
    width: 20,
    height: 2,
    backgroundColor: '#e2e8f0',
    marginHorizontal: 5,
  },
  
  successIconContainer: {
    width: 80,
    height: 80,
    borderRadius: 40,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#10b981',
    elevation: 5,
  },
  
  modalButton: {
    backgroundColor: '#8b5cf6',
    paddingHorizontal: 30,
    paddingVertical: 14,
    borderRadius: 15,
    marginTop: 25,
    elevation: 3,
  },
  
  modalButtonText: {
    color: 'white',
    fontWeight: 'bold',
    fontSize: 16,
  },
  
  // Empty state
  emptyContainer: {
    alignItems: 'center',
    padding: 40,
    borderRadius: 20,
    backgroundColor: '#ffffff',
    elevation: 3,
    borderWidth: 2,
    borderColor: '#334155',
  },
  
  emptyText: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#0f172a',
    marginTop: 20,
  },
  
  emptySubtext: {
    fontSize: 16,
    color: '#475569',
    marginTop: 8,
    textAlign: 'center',
    fontWeight: '500',
  },
  
  generateEmptyButton: {
    borderRadius: 15,
    marginTop: 25,
    elevation: 3,
  },
  
  generateEmptyButtonContent: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#8b5cf6',
    paddingHorizontal: 25,
    paddingVertical: 14,
    borderRadius: 15,
  },
  
  generateEmptyButtonText: {
    color: 'white',
    fontWeight: 'bold',
    fontSize: 15,
    marginLeft: 8,
  },
});
