// src/screens/SecretPhraseScreen.js - UPDATED WITH ENHANCED FEATURES
import React, { useState, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  ScrollView,
  FlatList,
  ActivityIndicator,
  RefreshControl,
  TouchableOpacity,
  SafeAreaView,
  TextInput,
  Dimensions,
  Modal,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { LinearGradient } from 'expo-linear-gradient';
import AsyncStorage from '@react-native-async-storage/async-storage';
import AIPromptGenerator from '../components/AIPromptGenerator';
import { useAnalytics } from '../hooks/useAnalytics';
import { logScreenView } from '../services/firebase';

const { width } = Dimensions.get('window');

export default function SecretPhraseScreen({ navigation }) {
  const [realTimeData, setRealTimeData] = useState([]);
  const [isConnected, setIsConnected] = useState(false);
  const [analyticsStats, setAnalyticsStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);
  const [selectedCategory, setSelectedCategory] = useState('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [showDefinitions, setShowDefinitions] = useState(true);
  const [showPremiumModal, setShowPremiumModal] = useState(false);
  const [selectedDefinition, setSelectedDefinition] = useState(null);
  const { logEvent } = useAnalytics();

  const [playerDataNBA, setPlayerDataNBA] = useState({
    name: 'LeBron James',
    team: 'LAL',
    position: 'SF',
    points: 28.5,
    rebounds: 8.2,
    assists: 8.8,
    gamesPlayed: 45
  });

  const [playerDataNFL, setPlayerDataNFL] = useState({
    name: 'Patrick Mahomes',
    team: 'KC',
    position: 'QB',
    passingYards: 4567,
    touchdowns: 38,
    interceptions: 12,
    gamesPlayed: 16
  });

  const [playerDataNHL, setPlayerDataNHL] = useState({
    name: 'Connor McDavid',
    team: 'EDM',
    position: 'C',
    goals: 45,
    assists: 68,
    points: 113,
    gamesPlayed: 67
  });

  const [playerDataMLB, setPlayerDataMLB] = useState({
    name: 'Shohei Ohtani',
    team: 'LAD',
    position: 'DH/SP',
    battingAvg: 0.304,
    homeRuns: 44,
    rbi: 95,
    era: 3.18
  });

  // Definitions of Secret Phrases (Only descriptions)
  const SECRET_PHRASE_DEFINITIONS = [
    // Advanced Analytics & Models
    {
      id: 'advanced_1',
      category: 'Advanced Analytics & Models',
      title: 'Predictive Clustering',
      description: 'Uses unsupervised learning to cluster similar game scenarios and predict outcomes',
      rarity: 'Legendary',
      requiresPremium: true,
      sport: 'All',
      icon: 'analytics'
    },
    {
      id: 'advanced_2',
      category: 'Advanced Analytics & Models',
      title: 'Bayesian Inference',
      description: 'Continuously updates probabilities with new information using Bayesian methods',
      rarity: 'Legendary',
      requiresPremium: true,
      sport: 'All',
      icon: 'trending-up'
    },
    {
      id: 'advanced_3',
      category: 'Advanced Analytics & Models',
      title: 'Gradient Boosted Models',
      description: 'Ensemble machine learning model that combines multiple weak predictors',
      rarity: 'Legendary',
      requiresPremium: true,
      sport: 'All',
      icon: 'bar-chart'
    },
    {
      id: 'advanced_4',
      category: 'Advanced Analytics & Models',
      title: 'Neural Network Ensemble',
      description: 'Combines multiple neural networks for higher accuracy predictions',
      rarity: 'Legendary',
      requiresPremium: true,
      sport: 'All',
      icon: 'git-network'
    },
    {
      id: 'advanced_5',
      category: 'Advanced Analytics & Models',
      title: 'Feature Importance',
      description: 'Identifies which statistics have highest predictive power for specific bets',
      rarity: 'Rare',
      requiresPremium: true,
      sport: 'All',
      icon: 'pulse'
    },
    
    // Advanced Injury Analytics
    {
      id: 'injury_1',
      category: 'Advanced Injury Analytics',
      title: 'Injury Cascades',
      description: 'Predicts secondary injury impacts (player B gets more minutes, then fatigues and gets injured)',
      rarity: 'Rare',
      requiresPremium: true,
      sport: 'All',
      icon: 'medical'
    },
    {
      id: 'injury_2',
      category: 'Advanced Injury Analytics',
      title: 'Recovery Timelines',
      description: 'Uses historical data to predict exact return dates from specific injuries',
      rarity: 'Rare',
      requiresPremium: true,
      sport: 'All',
      icon: 'calendar'
    },
    {
      id: 'injury_3',
      category: 'Advanced Injury Analytics',
      title: 'Injury Propensity',
      description: 'Identifies players at high risk for future injuries based on workload and biomechanics',
      rarity: 'Rare',
      requiresPremium: true,
      sport: 'All',
      icon: 'warning'
    },
    {
      id: 'injury_4',
      category: 'Advanced Injury Analytics',
      title: 'Load Management Value',
      description: 'Finds value in games where stars are rested for load management',
      rarity: 'Uncommon',
      requiresPremium: false,
      sport: 'NBA, NHL',
      icon: 'body'
    },
    {
      id: 'injury_5',
      category: 'Advanced Injury Analytics',
      title: 'Concussion Protocol Edge',
      description: 'Tracks teams/players with different concussion management approaches',
      rarity: 'Uncommon',
      requiresPremium: false,
      sport: 'NFL, NHL',
      icon: 'shield-checkmark'
    },
    
    // NHL-Specific Analytics
    {
      id: 'nhl_1',
      category: 'NHL-Specific Analytics',
      title: 'Goalie Fatigue',
      description: 'Tracks goalie workload and performance degradation with consecutive starts',
      rarity: 'Uncommon',
      requiresPremium: false,
      sport: 'NHL',
      icon: 'ice-cream'
    },
    {
      id: 'nhl_2',
      category: 'NHL-Specific Analytics',
      title: 'Special Teams Regression',
      description: 'Identifies power play/penalty kill units due for positive/negative regression',
      rarity: 'Rare',
      requiresPremium: true,
      sport: 'NHL',
      icon: 'refresh-circle'
    },
    {
      id: 'nhl_3',
      category: 'NHL-Specific Analytics',
      title: 'Shot Quality Analytics',
      description: 'Uses expected goals (xG) models to find value in puck line/total markets',
      rarity: 'Rare',
      requiresPremium: true,
      sport: 'NHL',
      icon: 'target'
    },
    {
      id: 'nhl_4',
      category: 'NHL-Specific Analytics',
      title: 'Back-to-Back Travel',
      description: 'Analyzes NHL team performance with different back-to-back travel scenarios',
      rarity: 'Common',
      requiresPremium: false,
      sport: 'NHL',
      icon: 'airplane'
    },
    {
      id: 'nhl_5',
      category: 'NHL-Specific Analytics',
      title: 'Defensive Pairing Matchups',
      description: 'Tracks how specific defensive pairings perform against opponent lines',
      rarity: 'Rare',
      requiresPremium: true,
      sport: 'NHL',
      icon: 'people'
    },
    {
      id: 'nhl_6',
      category: 'NHL-Specific Analytics',
      title: 'Faceoff Leverage',
      description: 'Identifies critical faceoff situations and specialists who excel in them',
      rarity: 'Uncommon',
      requiresPremium: false,
      sport: 'NHL',
      icon: 'hand-left'
    },
    {
      id: 'nhl_7',
      category: 'NHL-Specific Analytics',
      title: 'Post-Goal Momentum',
      description: 'Tracks team performance in the 5 minutes after scoring/conceding',
      rarity: 'Rare',
      requiresPremium: true,
      sport: 'NHL',
      icon: 'flash'
    },
    {
      id: 'nhl_8',
      category: 'NHL-Specific Analytics',
      title: 'Empty Net Strategies',
      description: 'Analyzes coach tendencies and success rates with empty net situations',
      rarity: 'Uncommon',
      requiresPremium: false,
      sport: 'NHL',
      icon: 'networking'
    },
    {
      id: 'nhl_9',
      category: 'NHL-Specific Analytics',
      title: 'Line Matching',
      description: 'Identifies which coaches aggressively match lines and the betting implications',
      rarity: 'Uncommon',
      requiresPremium: false,
      sport: 'NHL',
      icon: 'git-compare'
    },
    {
      id: 'nhl_10',
      category: 'NHL-Specific Analytics',
      title: 'Goalie Pull Timing',
      description: 'Analyzes optimal goalie pull times by team/coach and success rates',
      rarity: 'Rare',
      requiresPremium: true,
      sport: 'NHL',
      icon: 'time'
    }
  ];

  useEffect(() => {
    const simulateConnection = setTimeout(() => {
      setIsConnected(true);
    }, 1000);

    const mockAnalyticsData = {
      todaysStats: {
        todaysEvents: 24,
        todaysUnits: 12.5
      },
      categoryDistribution: [
        { _id: 'statistical_arbitrage', count: 8, avgConfidence: 82.5 },
        { _id: 'advanced_analytics', count: 6, avgConfidence: 75.2 },
        { _id: 'situational_edge', count: 5, avgConfidence: 68.9 },
        { _id: 'market_inefficiency', count: 3, avgConfidence: 91.3 },
        { _id: 'historical_patterns', count: 2, avgConfidence: 79.4 }
      ],
      recentEvents: [
        {
          id: 1,
          timestamp: new Date(),
          phraseCategory: 'statistical_arbitrage',
          phraseKey: 'Home team off back-to-back',
          inputText: 'Lakers vs Warriors',
          rarity: 'rare',
          sport: 'NBA',
          outcome: 'win',
          unitsWon: 2.5
        },
        {
          id: 2,
          timestamp: new Date(Date.now() - 3600000),
          phraseCategory: 'advanced_analytics',
          phraseKey: 'Player efficiency spike',
          inputText: 'Stephen Curry 3pt streak',
          rarity: 'uncommon',
          sport: 'NBA',
          outcome: 'win',
          unitsWon: 1.5
        }
      ]
    };

    const fetchData = () => {
      setLoading(true);
      setTimeout(() => {
        setAnalyticsStats(mockAnalyticsData);
        setRealTimeData(mockAnalyticsData.recentEvents || []);
        setLoading(false);
      }, 1500);
    };

    fetchData();
    
    logScreenView('SecretPhraseScreen', {
      category: selectedCategory,
    });

    return () => {
      clearTimeout(simulateConnection);
    };
  }, []);

  const fetchAnalyticsData = async () => {
    try {
      setLoading(true);
      setTimeout(() => {
        const mockData = {
          success: true,
          data: {
            todaysStats: {
              todaysEvents: 24,
              todaysUnits: 12.5
            },
            categoryDistribution: [
              { _id: 'statistical_arbitrage', count: 8, avgConfidence: 82.5 },
              { _id: 'advanced_analytics', count: 6, avgConfidence: 75.2 },
              { _id: 'situational_edge', count: 5, avgConfidence: 68.9 }
            ],
            recentEvents: [
              {
                id: Date.now(),
                timestamp: new Date(),
                phraseCategory: 'statistical_arbitrage',
                phraseKey: 'New event added',
                inputText: 'Test input',
                rarity: 'common',
                sport: 'NBA',
                outcome: 'pending'
              }
            ]
          }
        };
        setAnalyticsStats(mockData.data);
        setRealTimeData(prev => [...mockData.data.recentEvents, ...prev.slice(0, 8)]);
        setLoading(false);
        setRefreshing(false);
      }, 1000);
    } catch (error) {
      console.error('Error fetching analytics data:', error);
      setLoading(false);
      setRefreshing(false);
    }
  };

  const onRefresh = () => {
    setRefreshing(true);
    fetchAnalyticsData();
  };

  const getCategoryColor = (category) => {
    const colors = {
      'statistical_arbitrage': '#3B82F6',
      'advanced_analytics': '#8B5CF6',
      'situational_edge': '#10B981',
      'market_inefficiency': '#F59E0B',
      'historical_patterns': '#6366F1',
      'player_specific': '#EC4899',
      'injury_impact': '#EF4444',
      'live_betting': '#14B8A6',
    };
    return colors[category] || '#6B7280';
  };

  const getRarityColor = (rarity) => {
    const colors = {
      'common': '#9CA3AF',
      'uncommon': '#10B981',
      'rare': '#3B82F6',
      'legendary': '#8B5CF6',
    };
    return colors[rarity] || '#9CA3AF';
  };

  const getDefinitionCategoryColor = (category) => {
    const colors = {
      'Advanced Analytics & Models': '#3B82F6',
      'Advanced Injury Analytics': '#EF4444',
      'NHL-Specific Analytics': '#14B8A6',
    };
    return colors[category] || '#8B5CF6';
  };

  const filteredDefinitions = SECRET_PHRASE_DEFINITIONS.filter(definition => {
    const matchesSearch = searchQuery === '' || 
      definition.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
      definition.description.toLowerCase().includes(searchQuery.toLowerCase()) ||
      definition.category.toLowerCase().includes(searchQuery.toLowerCase()) ||
      definition.sport.toLowerCase().includes(searchQuery.toLowerCase());
    
    const matchesCategory = selectedCategory === 'all' || 
      definition.category === selectedCategory;
    
    return matchesSearch && matchesCategory;
  });

  const categories = ['all', ...new Set(SECRET_PHRASE_DEFINITIONS.map(d => d.category))];

  const renderEventItem = ({ item }) => (
    <TouchableOpacity 
      style={styles.secretEventCard}
      onPress={() => {
        logEvent('secret_phrase_event_selected', {
          phrase_key: item.phraseKey,
          category: item.phraseCategory,
          rarity: item.rarity,
        });
        // Alert.alert(
        //   'Secret Phrase Details',
        //   `Phrase: ${item.phraseKey}\n\nCategory: ${item.phraseCategory?.replace('_', ' ')}\nRarity: ${getRarityLabel(item.rarity)}\nSport: ${item.sport}\nOutcome: ${item.outcome}\nUnits: ${item.unitsWon || 'N/A'}`,
        //   [{ text: 'OK' }]
        // );
      }}
    >
      <View style={styles.eventHeader}>
        <Text style={styles.eventTime}>
          {new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
        </Text>
        <View style={[styles.categoryBadge, { backgroundColor: getCategoryColor(item.phraseCategory) }]}>
          <Text style={styles.categoryText}>{item.phraseCategory?.replace('_', ' ')}</Text>
        </View>
      </View>
      
      <Text style={styles.phraseText} numberOfLines={1}>{item.phraseKey || 'N/A'}</Text>
      
      {item.inputText && (
        <Text style={styles.inputText} numberOfLines={2}>{item.inputText}</Text>
      )}
      
      <View style={styles.eventFooter}>
        <View style={[styles.rarityBadge, { backgroundColor: getRarityColor(item.rarity) }]}>
          <Text style={styles.rarityText}>
            {item.rarity === 'common' ? 'Common' : 
             item.rarity === 'uncommon' ? 'Uncommon' : 
             item.rarity === 'rare' ? 'Rare' : 'Legendary'}
          </Text>
        </View>
        
        <Text style={styles.sportText}>{item.sport || 'N/A'}</Text>
        
        {item.outcome && (
          <View style={[
            styles.outcomeBadge,
            { backgroundColor: item.outcome === 'win' ? '#10B981' : item.outcome === 'loss' ? '#EF4444' : '#F59E0B' }
          ]}>
            <Text style={styles.outcomeText}>
              {item.outcome.toUpperCase()}
              {item.unitsWon && item.outcome === 'win' && ` (+${item.unitsWon})`}
              {item.unitsWon && item.outcome === 'loss' && ` (-${Math.abs(item.unitsWon)})`}
            </Text>
          </View>
        )}
      </View>
    </TouchableOpacity>
  );

  const renderDefinitionItem = ({ item }) => (
    <TouchableOpacity 
      style={styles.definitionCard}
      onPress={() => {
        if (item.requiresPremium) {
          setSelectedDefinition(item);
          setShowPremiumModal(true);
        } else {
          logEvent('secret_phrase_definition_selected', {
            definition: item.title,
            category: item.category,
            sport: item.sport,
          });
        }
      }}
    >
      <View style={styles.definitionHeader}>
        <View style={[styles.definitionCategoryBadge, { backgroundColor: getDefinitionCategoryColor(item.category) }]}>
          <Text style={styles.definitionCategoryText}>{item.category}</Text>
        </View>
        {item.requiresPremium && (
          <View style={styles.premiumBadge}>
            <Ionicons name="diamond" size={12} color="#F59E0B" />
            <Text style={styles.premiumText}>PREMIUM</Text>
          </View>
        )}
      </View>
      
      <View style={styles.definitionContent}>
        <View style={styles.definitionTitleRow}>
          <Ionicons name={item.icon || 'analytics'} size={20} color="#3B82F6" />
          <Text style={styles.definitionTitle}>{item.title}</Text>
        </View>
        
        <Text style={styles.definitionDescription}>{item.description}</Text>
        
        <View style={styles.definitionFooter}>
          <View style={[styles.rarityBadge, { backgroundColor: getRarityColor(item.rarity.toLowerCase()) }]}>
            <Text style={styles.rarityText}>{item.rarity}</Text>
          </View>
          
          <View style={styles.sportBadge}>
            <Ionicons name="american-football" size={12} color="#6B7280" />
            <Text style={styles.sportBadgeText}>{item.sport}</Text>
          </View>
        </View>
      </View>
    </TouchableOpacity>
  );

  const PremiumModal = () => (
    <Modal
      animationType="fade"
      transparent={true}
      visible={showPremiumModal}
      onRequestClose={() => setShowPremiumModal(false)}
    >
      <View style={styles.modalOverlay}>
        <View style={styles.modalContent}>
          <LinearGradient
            colors={['#8B5CF6', '#6366F1']}
            style={styles.modalHeader}
          >
            <Ionicons name="diamond" size={40} color="white" />
            <Text style={styles.modalTitle}>Premium Feature</Text>
            <Text style={styles.modalSubtitle}>Unlock Advanced Analytics</Text>
          </LinearGradient>
          
          <View style={styles.modalBody}>
            {selectedDefinition && (
              <>
                <Text style={styles.modalFeatureTitle}>{selectedDefinition.title}</Text>
                <Text style={styles.modalFeatureDescription}>{selectedDefinition.description}</Text>
                
                <View style={styles.premiumBenefits}>
                  <Text style={styles.benefitsTitle}>Premium Benefits:</Text>
                  <View style={styles.benefitItem}>
                    <Ionicons name="checkmark-circle" size={20} color="#10B981" />
                    <Text style={styles.benefitText}>Access to {selectedDefinition.title} analytics</Text>
                  </View>
                  <View style={styles.benefitItem}>
                    <Ionicons name="checkmark-circle" size={20} color="#10B981" />
                    <Text style={styles.benefitText}>Real-time predictions and insights</Text>
                  </View>
                  <View style={styles.benefitItem}>
                    <Ionicons name="checkmark-circle" size={20} color="#10B981" />
                    <Text style={styles.benefitText}>Priority customer support</Text>
                  </View>
                  <View style={styles.benefitItem}>
                    <Ionicons name="checkmark-circle" size={20} color="#10B981" />
                    <Text style={styles.benefitText}>Advanced statistical models</Text>
                  </View>
                </View>
              </>
            )}
            
            <TouchableOpacity 
              style={styles.upgradeButton}
              onPress={() => {
                logEvent('premium_upgrade_clicked', {
                  feature: selectedDefinition?.title,
                  category: selectedDefinition?.category,
                });
                setShowPremiumModal(false);
                // Navigation to upgrade screen would go here
              }}
            >
              <LinearGradient
                colors={['#8B5CF6', '#6366F1']}
                style={styles.upgradeButtonGradient}
              >
                <Ionicons name="diamond" size={20} color="white" />
                <Text style={styles.upgradeButtonText}>Upgrade to Premium - $29.99/month</Text>
              </LinearGradient>
            </TouchableOpacity>
            
            <TouchableOpacity 
              style={styles.cancelButton}
              onPress={() => setShowPremiumModal(false)}
            >
              <Text style={styles.cancelButtonText}>Maybe Later</Text>
            </TouchableOpacity>
          </View>
        </View>
      </View>
    </Modal>
  );

  if (loading) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color="#3B82F6" />
        <Text style={styles.loadingText}>Loading secret phrase analytics...</Text>
      </View>
    );
  }

  return (
    <SafeAreaView style={styles.safeArea}>
      <ScrollView 
        style={styles.scrollView}
        refreshControl={
          <RefreshControl refreshing={refreshing} onRefresh={onRefresh} />
        }
        showsVerticalScrollIndicator={false}
      >
        {/* Header Section */}
        <LinearGradient
          colors={['#1e3a8a', '#3b82f6']}
          style={styles.headerGradient}
        >
          <View style={styles.headerContent}>
            <View style={styles.headerTop}>
              <TouchableOpacity 
                style={styles.backButton}
                onPress={() => navigation.goBack()}
              >
                <Ionicons name="arrow-back" size={24} color="white" />
              </TouchableOpacity>
              <View style={styles.headerTitleContainer}>
                <Text style={styles.secretTitle}>Secret Phrase Analytics</Text>
                <View style={styles.connectionRow}>
                  <View style={[styles.statusDot, { backgroundColor: isConnected ? '#10B981' : '#EF4444' }]} />
                  <Text style={styles.connectionText}>
                    {isConnected ? 'Live Analytics Connected' : 'Disconnected'}
                  </Text>
                </View>
              </View>
              <View style={{ width: 40 }} />
            </View>
            
            <Text style={styles.headerSubtitle}>
              Advanced AI-powered insights and predictive analytics for professional sports betting
            </Text>
            
            {analyticsStats && (
              <View style={styles.secretStatsContainer}>
                <View style={styles.statsRow}>
                  <View style={styles.statItem}>
                    <Ionicons name="flash" size={24} color="#F59E0B" />
                    <Text style={styles.statValue}>{analyticsStats.todaysStats?.todaysEvents || 0}</Text>
                    <Text style={styles.statLabel}>Today's Events</Text>
                  </View>
                  <View style={styles.statDivider} />
                  <View style={styles.statItem}>
                    <Ionicons name="trending-up" size={24} color="#10B981" />
                    <Text style={styles.statValue}>{analyticsStats.todaysStats?.todaysUnits || 0}</Text>
                    <Text style={styles.statLabel}>Units Won</Text>
                  </View>
                </View>
              </View>
            )}
          </View>
        </LinearGradient>

        {/* Search Section */}
        <View style={styles.searchSection}>
          <View style={styles.searchContainer}>
            <Ionicons name="search" size={20} color="#6B7280" style={styles.searchIcon} />
            <TextInput
              style={styles.searchInput}
              placeholder="Search secret phrase definitions..."
              placeholderTextColor="#9CA3AF"
              value={searchQuery}
              onChangeText={setSearchQuery}
            />
            {searchQuery.length > 0 && (
              <TouchableOpacity onPress={() => setSearchQuery('')}>
                <Ionicons name="close-circle" size={20} color="#9CA3AF" />
              </TouchableOpacity>
            )}
          </View>
        </View>

        {/* Category Filter */}
        <ScrollView 
          horizontal 
          showsHorizontalScrollIndicator={false} 
          style={styles.categoryScroll}
          contentContainerStyle={styles.categoryScrollContent}
        >
          {categories.map(cat => (
            <TouchableOpacity
              key={cat}
              style={[
                styles.categoryButton,
                selectedCategory === cat && styles.categoryButtonActive,
                cat === 'all' ? { backgroundColor: selectedCategory === 'all' ? '#3B82F6' : '#E5E7EB' } : 
                { backgroundColor: selectedCategory === cat ? getDefinitionCategoryColor(cat) : '#F3F4F6' }
              ]}
              onPress={() => setSelectedCategory(cat)}
            >
              <Text style={[
                styles.categoryButtonText,
                selectedCategory === cat && styles.categoryButtonTextActive,
                { color: selectedCategory === cat ? 'white' : cat === 'all' ? '#1F2937' : '#4B5563' }
              ]}>
                {cat === 'all' ? 'All Categories' : cat}
              </Text>
            </TouchableOpacity>
          ))}
        </ScrollView>

        {/* Definitions Section */}
        <View style={styles.section}>
          <TouchableOpacity 
            style={styles.sectionHeader}
            onPress={() => setShowDefinitions(!showDefinitions)}
          >
            <View style={styles.sectionTitleContainer}>
              <Ionicons name="book" size={24} color="#3B82F6" />
              <Text style={styles.sectionTitle}>Secret Phrase Definitions</Text>
            </View>
            <Ionicons 
              name={showDefinitions ? "chevron-up" : "chevron-down"} 
              size={24} 
              color="#6B7280" 
            />
          </TouchableOpacity>
          
          {showDefinitions && (
            <View style={styles.definitionsContainer}>
              <Text style={styles.sectionDescription}>
                Advanced analytics models and insights powered by machine learning and AI. 
                These definitions explain the capabilities of our premium secret phrases.
              </Text>
              
              <FlatList
                data={filteredDefinitions}
                renderItem={renderDefinitionItem}
                keyExtractor={(item) => item.id}
                scrollEnabled={false}
                ListEmptyComponent={
                  <View style={styles.emptyContainer}>
                    <Ionicons name="search" size={48} color="#9CA3AF" />
                    <Text style={styles.emptyText}>No definitions match your search</Text>
                  </View>
                }
              />
              
              <View style={styles.definitionsFooter}>
                <Ionicons name="information-circle" size={16} color="#6B7280" />
                <Text style={styles.definitionsFooterText}>
                  {filteredDefinitions.length} of {SECRET_PHRASE_DEFINITIONS.length} definitions shown
                </Text>
              </View>
            </View>
          )}
        </View>

        {/* AI Prompt Generators Section */}
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <View style={styles.sectionTitleContainer}>
              <Ionicons name="sparkles" size={24} color="#8B5CF6" />
              <Text style={styles.sectionTitle}>AI-Powered Phrase Generator</Text>
            </View>
          </View>
          
          <Text style={styles.sectionDescription}>
            Generate insights using AI. Enter player stats or game scenarios to get advanced analytics.
          </Text>
          
          <View style={styles.aiGeneratorGrid}>
            <View style={styles.aiGeneratorCard}>
              <View style={styles.aiGeneratorHeader}>
                <Ionicons name="basketball" size={20} color="#EF4444" />
                <Text style={styles.aiGeneratorTitle}>NBA Analytics</Text>
              </View>
              <AIPromptGenerator 
                playerData={playerDataNBA}
                sport="NBA"
                style={styles.aiGenerator}
              />
            </View>
            
            <View style={styles.aiGeneratorCard}>
              <View style={styles.aiGeneratorHeader}>
                <Ionicons name="american-football" size={20} color="#F59E0B" />
                <Text style={styles.aiGeneratorTitle}>NFL Analytics</Text>
              </View>
              <AIPromptGenerator 
                playerData={playerDataNFL}
                sport="NFL"
                style={styles.aiGenerator}
              />
            </View>
            
            <View style={styles.aiGeneratorCard}>
              <View style={styles.aiGeneratorHeader}>
                <Ionicons name="ice-cream" size={20} color="#3B82F6" />
                <Text style={styles.aiGeneratorTitle}>NHL Analytics</Text>
              </View>
              <AIPromptGenerator 
                playerData={playerDataNHL}
                sport="NHL"
                style={styles.aiGenerator}
              />
            </View>
            
            <View style={styles.aiGeneratorCard}>
              <View style={styles.aiGeneratorHeader}>
                <Ionicons name="baseball" size={20} color="#10B981" />
                <Text style={styles.aiGeneratorTitle}>MLB Analytics</Text>
              </View>
              <AIPromptGenerator 
                playerData={playerDataMLB}
                sport="MLB"
                style={styles.aiGenerator}
              />
            </View>
          </View>
        </View>

        {/* Recent Events Section */}
        <View style={styles.section}>
          <View style={styles.sectionHeader}>
            <View style={styles.sectionTitleContainer}>
              <Ionicons name="time" size={24} color="#10B981" />
              <Text style={styles.sectionTitle}>Recent Phrase Activity</Text>
            </View>
          </View>
          
          <FlatList
            data={realTimeData}
            renderItem={renderEventItem}
            keyExtractor={(item, index) => item.id ? item.id.toString() : index.toString()}
            scrollEnabled={false}
            ListEmptyComponent={
              <View style={styles.emptyContainer}>
                <Ionicons name="analytics-outline" size={48} color="#9ca3af" />
                <Text style={styles.emptyText}>
                  No recent activity. Secret phrases will appear here as they're used.
                </Text>
              </View>
            }
          />
        </View>

        {/* Footer */}
        <View style={styles.footer}>
          <Ionicons name="shield-checkmark" size={20} color="#3B82F6" />
          <Text style={styles.footerText}>
            All analytics are powered by proprietary AI models and real-time data feeds.
          </Text>
        </View>
      </ScrollView>
      
      <PremiumModal />
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  safeArea: {
    flex: 1,
    backgroundColor: '#f8fafc',
  },
  scrollView: {
    flex: 1,
    backgroundColor: '#f8fafc',
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#f8fafc',
    padding: 40,
  },
  loadingText: {
    marginTop: 16,
    color: '#4b5563',
    fontSize: 16,
    fontWeight: '500',
  },
  
  // Header Styles
  headerGradient: {
    borderBottomLeftRadius: 20,
    borderBottomRightRadius: 20,
    paddingBottom: 24,
  },
  headerContent: {
    paddingHorizontal: 20,
    paddingTop: 20,
  },
  headerTop: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
    marginBottom: 16,
  },
  backButton: {
    padding: 8,
  },
  headerTitleContainer: {
    flex: 1,
    alignItems: 'center',
  },
  secretTitle: {
    fontSize: 28,
    fontWeight: 'bold',
    color: 'white',
    textAlign: 'center',
    marginBottom: 8,
  },
  headerSubtitle: {
    fontSize: 14,
    color: 'rgba(255, 255, 255, 0.9)',
    textAlign: 'center',
    lineHeight: 20,
    marginBottom: 20,
    paddingHorizontal: 20,
  },
  connectionRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
  },
  statusDot: {
    width: 8,
    height: 8,
    borderRadius: 4,
    marginRight: 8,
  },
  connectionText: {
    fontSize: 12,
    color: 'rgba(255, 255, 255, 0.8)',
  },
  secretStatsContainer: {
    backgroundColor: 'rgba(255, 255, 255, 0.1)',
    borderRadius: 12,
    padding: 16,
    borderWidth: 1,
    borderColor: 'rgba(255, 255, 255, 0.2)',
  },
  statsRow: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-around',
  },
  statItem: {
    alignItems: 'center',
    flex: 1,
  },
  statDivider: {
    width: 1,
    height: 40,
    backgroundColor: 'rgba(255, 255, 255, 0.2)',
  },
  statValue: {
    fontSize: 24,
    fontWeight: 'bold',
    color: 'white',
    marginTop: 8,
    marginBottom: 4,
  },
  statLabel: {
    fontSize: 12,
    color: 'rgba(255, 255, 255, 0.8)',
  },
  
  // Search Section
  searchSection: {
    paddingHorizontal: 20,
    paddingTop: 20,
    paddingBottom: 16,
  },
  searchContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: 'white',
    borderRadius: 12,
    paddingHorizontal: 16,
    paddingVertical: 12,
    borderWidth: 1,
    borderColor: '#E5E7EB',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.05,
    shadowRadius: 3,
    elevation: 2,
  },
  searchIcon: {
    marginRight: 12,
  },
  searchInput: {
    flex: 1,
    fontSize: 16,
    color: '#1F2937',
    padding: 0,
  },
  
  // Category Filter
  categoryScroll: {
    marginBottom: 16,
    paddingLeft: 20,
  },
  categoryScrollContent: {
    paddingRight: 20,
  },
  categoryButton: {
    paddingHorizontal: 16,
    paddingVertical: 10,
    borderRadius: 20,
    marginRight: 8,
    minWidth: 120,
    alignItems: 'center',
    justifyContent: 'center',
  },
  categoryButtonActive: {
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  categoryButtonText: {
    fontSize: 14,
    fontWeight: '500',
  },
  categoryButtonTextActive: {
    color: 'white',
    fontWeight: '600',
  },
  
  // Section Styles
  section: {
    marginHorizontal: 20,
    marginBottom: 24,
    backgroundColor: 'white',
    borderRadius: 16,
    padding: 20,
    borderWidth: 1,
    borderColor: '#E5E7EB',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.05,
    shadowRadius: 3,
    elevation: 2,
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 16,
  },
  sectionTitleContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#1F2937',
    marginLeft: 12,
  },
  sectionDescription: {
    fontSize: 14,
    color: '#6B7280',
    lineHeight: 20,
    marginBottom: 20,
  },
  
  // Definitions
  definitionsContainer: {
    marginTop: 8,
  },
  definitionCard: {
    backgroundColor: '#F9FAFB',
    borderRadius: 12,
    padding: 16,
    marginBottom: 12,
    borderWidth: 1,
    borderColor: '#E5E7EB',
  },
  definitionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 12,
  },
  definitionCategoryBadge: {
    paddingHorizontal: 10,
    paddingVertical: 4,
    borderRadius: 6,
  },
  definitionCategoryText: {
    fontSize: 11,
    color: 'white',
    fontWeight: '600',
    textTransform: 'uppercase',
  },
  premiumBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#FEF3C7',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
    borderWidth: 1,
    borderColor: '#F59E0B',
  },
  premiumText: {
    fontSize: 10,
    color: '#92400E',
    fontWeight: '700',
    marginLeft: 4,
  },
  definitionContent: {
    flex: 1,
  },
  definitionTitleRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 8,
  },
  definitionTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#1F2937',
    marginLeft: 8,
    flex: 1,
  },
  definitionDescription: {
    fontSize: 14,
    color: '#4B5563',
    lineHeight: 20,
    marginBottom: 12,
  },
  definitionFooter: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  sportBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: '#F3F4F6',
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
  },
  sportBadgeText: {
    fontSize: 12,
    color: '#6B7280',
    marginLeft: 4,
    fontWeight: '500',
  },
  definitionsFooter: {
    flexDirection: 'row',
    alignItems: 'center',
    marginTop: 16,
    paddingTop: 16,
    borderTopWidth: 1,
    borderTopColor: '#E5E7EB',
  },
  definitionsFooterText: {
    fontSize: 12,
    color: '#6B7280',
    marginLeft: 8,
    fontWeight: '500',
  },
  
  // AI Generator
  aiGeneratorGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    justifyContent: 'space-between',
    marginHorizontal: -4,
  },
  aiGeneratorCard: {
    width: '48%',
    marginBottom: 12,
  },
  aiGeneratorHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 8,
    paddingLeft: 8,
  },
  aiGeneratorTitle: {
    fontSize: 14,
    fontWeight: '600',
    color: '#1F2937',
    marginLeft: 8,
  },
  aiGenerator: {
    flex: 1,
  },
  
  // Event Cards
  secretEventCard: {
    backgroundColor: '#F9FAFB',
    borderRadius: 12,
    padding: 16,
    marginBottom: 12,
    borderWidth: 1,
    borderColor: '#E5E7EB',
  },
  eventHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 8,
  },
  eventTime: {
    fontSize: 12,
    color: '#6B7280',
    fontWeight: '500',
  },
  categoryBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
  },
  categoryText: {
    fontSize: 10,
    color: 'white',
    fontWeight: '600',
    textTransform: 'uppercase',
  },
  phraseText: {
    fontSize: 16,
    fontWeight: '600',
    color: '#1F2937',
    marginBottom: 4,
  },
  inputText: {
    fontSize: 14,
    color: '#6B7280',
    marginBottom: 12,
    fontStyle: 'italic',
    lineHeight: 18,
  },
  eventFooter: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
  },
  rarityBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
  },
  rarityText: {
    fontSize: 10,
    color: 'white',
    fontWeight: '600',
  },
  sportText: {
    fontSize: 12,
    color: '#6B7280',
    fontWeight: '500',
  },
  outcomeBadge: {
    paddingHorizontal: 8,
    paddingVertical: 4,
    borderRadius: 6,
  },
  outcomeText: {
    fontSize: 10,
    color: 'white',
    fontWeight: '600',
  },
  
  // Empty States
  emptyContainer: {
    padding: 32,
    alignItems: 'center',
    backgroundColor: '#F9FAFB',
    borderRadius: 12,
    borderWidth: 1,
    borderColor: '#E5E7EB',
  },
  emptyText: {
    fontSize: 14,
    color: '#6B7280',
    textAlign: 'center',
    marginTop: 16,
    lineHeight: 20,
  },
  
  // Footer
  footer: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 20,
    marginHorizontal: 20,
    marginBottom: 32,
    backgroundColor: 'white',
    borderRadius: 12,
    borderWidth: 1,
    borderColor: '#E5E7EB',
  },
  footerText: {
    fontSize: 12,
    color: '#6B7280',
    marginLeft: 12,
    flex: 1,
    lineHeight: 16,
  },
  
  // Modal Styles
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: 20,
  },
  modalContent: {
    width: width * 0.9,
    maxWidth: 400,
    backgroundColor: 'white',
    borderRadius: 20,
    overflow: 'hidden',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 10 },
    shadowOpacity: 0.3,
    shadowRadius: 20,
    elevation: 10,
  },
  modalHeader: {
    padding: 24,
    alignItems: 'center',
  },
  modalTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: 'white',
    marginTop: 12,
  },
  modalSubtitle: {
    fontSize: 14,
    color: 'rgba(255, 255, 255, 0.9)',
    marginTop: 4,
  },
  modalBody: {
    padding: 24,
  },
  modalFeatureTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: '#1F2937',
    marginBottom: 8,
  },
  modalFeatureDescription: {
    fontSize: 14,
    color: '#6B7280',
    lineHeight: 20,
    marginBottom: 24,
  },
  premiumBenefits: {
    marginBottom: 24,
  },
  benefitsTitle: {
    fontSize: 16,
    fontWeight: '600',
    color: '#1F2937',
    marginBottom: 12,
  },
  benefitItem: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 8,
  },
  benefitText: {
    fontSize: 14,
    color: '#4B5563',
    marginLeft: 8,
    flex: 1,
  },
  upgradeButton: {
    marginBottom: 16,
  },
  upgradeButtonGradient: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: 16,
    borderRadius: 12,
  },
  upgradeButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: 'white',
    marginLeft: 8,
  },
  cancelButton: {
    paddingVertical: 12,
    alignItems: 'center',
  },
  cancelButtonText: {
    fontSize: 16,
    color: '#6B7280',
    fontWeight: '500',
  },
});
